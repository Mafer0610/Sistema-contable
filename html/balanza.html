<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Balanza de Comprobación - SKY HOME</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="../js/balanza.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #b19cd9 0%, #c2a5db 50%, #d4b3e0 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .main-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      margin: 30px auto;
      padding: 40px;
      max-width: 1200px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .page-title {
      color: #6b46a3;
      font-weight: bold;
      font-size: 2rem;
      text-align: center;
      margin-bottom: 30px;
    }
    .btn-back {
      background: rgba(228, 165, 232, 0.8);
      color: #6b46a3;
      border: 2px solid #6b46a3;
      border-radius: 10px;
      padding: 10px 20px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      margin-bottom: 20px;
    }
    .btn-back:hover {
      background: #6b46a3;
      color: white;
      text-decoration: none;
    }
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    .summary-card {
      background: rgba(228, 165, 232, 0.3);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      border: 2px solid rgba(107, 70, 163, 0.2);
    }
    .summary-title {
      color: #6b46a3;
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 10px;
    }
    .summary-value {
      color: #333;
      font-size: 2rem;
      font-weight: bold;
    }
    .balance-status {
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
      text-align: center;
      font-weight: 600;
      font-size: 1.2rem;
    }
    .balance-equilibrado {
      background: rgba(40, 167, 69, 0.2);
      color: #28a745;
      border: 2px solid #28a745;
    }
    .balance-desequilibrado {
      background: rgba(220, 53, 69, 0.2);
      color: #dc3545;
      border: 2px solid #dc3545;
    }
    .table-container {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 15px;
      overflow: hidden;
      border: 2px solid #e4a5e8;
      margin-top: 20px;
    }
    .table th {
      background: #6b46a3;
      color: white;
      font-weight: 600;
      padding: 15px;
      border: none;
    }
    .table td {
      padding: 15px;
      border-bottom: 1px solid #e4a5e8;
    }
    .table-footer {
      background: rgba(107, 70, 163, 0.1);
      font-weight: bold;
    }
    .section-title {
      color: #6b46a3;
      font-weight: 600;
      font-size: 1.5rem;
      margin: 30px 0 20px 0;
    }
    .btn-generate {
      background: linear-gradient(135deg, #6b46a3, #8e7cc3);
      border: none;
      border-radius: 10px;
      padding: 12px 25px;
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .btn-generate:hover {
      background: linear-gradient(135deg, #5a3a8a, #7a6bb0);
      transform: translateY(-2px);
    }
    .alert-info {
      background: rgba(228, 165, 232, 0.2);
      border: 2px solid #e4a5e8;
      border-radius: 15px;
      color: #6b46a3;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <a href="panel.html" class="btn-back">← Volver al Panel</a>
    
    <h1 class="page-title">Balanza de Comprobación</h1>

    <!-- Botón para generar balanza -->
    <div class="text-center mb-4">
      <button onclick="generarBalanza()" class="btn btn-generate">
        Generar Balanza de Comprobación
      </button>
    </div>

    <!-- Resumen ejecutivo -->
    <div class="summary-cards">
      <div class="summary-card">
        <div class="summary-title">Total Debe</div>
        <div class="summary-value" id="totalDebe">$0.00</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Total Haber</div>
        <div class="summary-value" id="totalHaber">$0.00</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Diferencia</div>
        <div class="summary-value" id="diferencia">$0.00</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Número de Cuentas</div>
        <div class="summary-value" id="numeroCuentas">0</div>
      </div>
    </div>

    <!-- Estado del balance -->
    <div id="estadoBalance" class="balance-status" style="display: none;">
      <!-- El estado se mostrará aquí -->
    </div>

    <!-- Información -->
    <div class="alert alert-info">
      <h5><strong>¿Qué es la Balanza de Comprobación?</strong></h5>
      <p class="mb-0">
        La Balanza de Comprobación es un reporte contable que muestra todos los saldos de las cuentas 
        del libro mayor en una fecha específica. Su propósito principal es verificar que la suma 
        total de los débitos sea igual a la suma total de los créditos.
      </p>
    </div>

    <!-- Tabla de balanza -->
    <h2 class="section-title">Detalle de Cuentas</h2>
    <div class="table-container">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Código</th>
              <th>Nombre de la Cuenta</th>
              <th>Debe</th>
              <th>Haber</th>
              <th>Saldo Deudor</th>
              <th>Saldo Acreedor</th>
            </tr>
          </thead>
          <tbody id="balanzaTable">
            <tr>
              <td colspan="6" class="text-center">Presione "Generar Balanza de Comprobación" para mostrar los datos</td>
            </tr>
          </tbody>
          <tfoot id="balanzaFooter" style="display: none;">
            <tr class="table-footer">
              <td><strong>TOTALES:</strong></td>
              <td></td>
              <td id="footerDebe"><strong>$0.00</strong></td>
              <td id="footerHaber"><strong>$0.00</strong></td>
              <td id="footerDeudor"><strong>$0.00</strong></td>
              <td id="footerAcreedor"><strong>$0.00</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Análisis de cuentas -->
    <div id="analisisCuentas" style="display: none;">
      <h2 class="section-title">Análisis por Tipo de Cuenta</h2>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Tipo de Cuenta</th>
              <th>Cantidad</th>
              <th>Total Debe</th>
              <th>Total Haber</th>
              <th>Saldo Neto</th>
            </tr>
          </thead>
          <tbody id="analisisTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Generar balanza de comprobación
    function generarBalanza() {
      const movimientos = JSON.parse(localStorage.getItem('movimientos')) || [];
      
      if (movimientos.length === 0) {
        alert('No hay movimientos registrados para generar la balanza.');
        return;
      }
      
      // Agrupar movimientos por cuenta
      const cuentas = {};
      
      movimientos.forEach(mov => {
        if (!cuentas[mov.cuenta]) {
          cuentas[mov.cuenta] = {
            nombre: mov.cuenta,
            debe: 0,
            haber: 0,
            saldoDeudor: 0,
            saldoAcreedor: 0,
            tipo: determinarTipoCuenta(mov.cuenta)
          };
        }
        
        cuentas[mov.cuenta].debe += parseFloat(mov.cargo) || 0;
        cuentas[mov.cuenta].haber += parseFloat(mov.abono) || 0;
      });
      
      // Calcular saldos
      Object.keys(cuentas).forEach(cuenta => {
        const saldo = cuentas[cuenta].debe - cuentas[cuenta].haber;
        if (saldo > 0) {
          cuentas[cuenta].saldoDeudor = saldo;
          cuentas[cuenta].saldoAcreedor = 0;
        } else {
          cuentas[cuenta].saldoDeudor = 0;
          cuentas[cuenta].saldoAcreedor = Math.abs(saldo);
        }
      });
      
      mostrarBalanza(Object.values(cuentas));
      mostrarResumen(Object.values(cuentas));
      mostrarAnalisis(Object.values(cuentas));
    }

    function determinarTipoCuenta(nombreCuenta) {
      const nombre = nombreCuenta.toLowerCase();
      if (nombre.includes('venta') || nombre.includes('ingreso') || nombre.includes('ganancia')) {
        return 'Ingresos';
      } else if (nombre.includes('compra') || nombre.includes('gasto') || nombre.includes('costo')) {
        return 'Gastos';
      } else if (nombre.includes('efectivo') || nombre.includes('banco') || nombre.includes('inventario') || nombre.includes('cuenta') && nombre.includes('cobrar')) {
        return 'Activos';
      } else if (nombre.includes('deuda') || nombre.includes('préstamo') || nombre.includes('pagar')) {
        return 'Pasivos';
      } else if (nombre.includes('capital') || nombre.includes('patrimonio')) {
        return 'Capital';
      }
      return 'Otros';
    }

    function mostrarBalanza(cuentas) {
      const tbody = document.getElementById('balanzaTable');
      tbody.innerHTML = '';
      
      // Ordenar cuentas alfabéticamente
      cuentas.sort((a, b) => a.nombre.localeCompare(b.nombre));
      
      let totalDebe = 0;
      let totalHaber = 0;
      let totalDeudor = 0;
      let totalAcreedor = 0;
      
      cuentas.forEach((cuenta, index) => {
        totalDebe += cuenta.debe;
        totalHaber += cuenta.haber;
        totalDeudor += cuenta.saldoDeudor;
        totalAcreedor += cuenta.saldoAcreedor;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${(index + 1).toString().padStart(3, '0')}</td>
          <td><strong>${cuenta.nombre}</strong> <span class="badge" style="background: #e4a5e8; color: #6b46a3; font-size: 0.7em;">${cuenta.tipo}</span></td>
          <td>${cuenta.debe.toFixed(2)}</td>
          <td>${cuenta.haber.toFixed(2)}</td>
          <td>${cuenta.saldoDeudor > 0 ? ' + cuenta.saldoDeudor.toFixed(2) : '-'}</td>
          <td>${cuenta.saldoAcreedor > 0 ? ' + cuenta.saldoAcreedor.toFixed(2) : '-'}</td>
        `;
        tbody.appendChild(row);
      });
      
      // Mostrar totales en el footer
      document.getElementById('footerDebe').innerHTML = `<strong>${totalDebe.toFixed(2)}</strong>`;
      document.getElementById('footerHaber').innerHTML = `<strong>${totalHaber.toFixed(2)}</strong>`;
      document.getElementById('footerDeudor').innerHTML = `<strong>${totalDeudor.toFixed(2)}</strong>`;
      document.getElementById('footerAcreedor').innerHTML = `<strong>${totalAcreedor.toFixed(2)}</strong>`;
      document.getElementById('balanzaFooter').style.display = 'table-footer-group';
    }

    function mostrarResumen(cuentas) {
      let totalDebe = 0;
      let totalHaber = 0;
      
      cuentas.forEach(cuenta => {
        totalDebe += cuenta.debe;
        totalHaber += cuenta.haber;
      });
      
      const diferencia = totalDebe - totalHaber;
      const equilibrada = Math.abs(diferencia) < 0.01; // Tolerancia de 1 centavo
      
      // Actualizar tarjetas de resumen
      document.getElementById('totalDebe').textContent = `${totalDebe.toFixed(2)}`;
      document.getElementById('totalHaber').textContent = `${totalHaber.toFixed(2)}`;
      document.getElementById('diferencia').textContent = `${diferencia.toFixed(2)}`;
      document.getElementById('numeroCuentas').textContent = cuentas.length;
      
      // Mostrar estado del balance
      const estadoDiv = document.getElementById('estadoBalance');
      estadoDiv.style.display = 'block';
      
      if (equilibrada) {
        estadoDiv.className = 'balance-status balance-equilibrado';
        estadoDiv.innerHTML = `
          <i class="fas fa-check-circle"></i>
          <strong>✓ BALANZA EQUILIBRADA</strong><br>
          Los totales de Debe y Haber coinciden. La contabilidad está balanceada.
        `;
      } else {
        estadoDiv.className = 'balance-status balance-desequilibrado';
        estadoDiv.innerHTML = `
          <i class="fas fa-exclamation-triangle"></i>
          <strong>⚠ BALANZA DESEQUILIBRADA</strong><br>
          Diferencia de ${Math.abs(diferencia).toFixed(2)}. Revise los asientos contables.
        `;
      }
    }

    function mostrarAnalisis(cuentas) {
      const tiposCuenta = {};
      
      cuentas.forEach(cuenta => {
        if (!tiposCuenta[cuenta.tipo]) {
          tiposCuenta[cuenta.tipo] = {
            cantidad: 0,
            totalDebe: 0,
            totalHaber: 0
          };
        }
        
        tiposCuenta[cuenta.tipo].cantidad++;
        tiposCuenta[cuenta.tipo].totalDebe += cuenta.debe;
        tiposCuenta[cuenta.tipo].totalHaber += cuenta.haber;
      });
      
      const tbody = document.getElementById('analisisTable');
      tbody.innerHTML = '';
      
      Object.keys(tiposCuenta).forEach(tipo => {
        const datos = tiposCuenta[tipo];
        const saldoNeto = datos.totalDebe - datos.totalHaber;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${tipo}</strong></td>
          <td>${datos.cantidad}</td>
          <td>${datos.totalDebe.toFixed(2)}</td>
          <td>${datos.totalHaber.toFixed(2)}</td>
          <td class="${saldoNeto >= 0 ? 'text-success' : 'text-danger'}">
            ${saldoNeto.toFixed(2)}
          </td>
        `;
        tbody.appendChild(row);
      });
      
      document.getElementById('analisisCuentas').style.display = 'block';
    }

    // Cargar datos al cargar la página si existen movimientos
    document.addEventListener('DOMContentLoaded', function() {
      const movimientos = JSON.parse(localStorage.getItem('movimientos')) || [];
      if (movimientos.length > 0) {
        // Auto-generar balanza si hay datos
        setTimeout(() => {
          generarBalanza();
        }, 500);
      }
    });
  </script>
</body>
</html>