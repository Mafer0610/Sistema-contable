<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Libro Mayor - SKY HOME</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="../js/mayor.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #b19cd9 0%, #c2a5db 50%, #d4b3e0 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .main-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      margin: 30px auto;
      padding: 40px;
      max-width: 1000px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .page-title {
      color: #6b46a3;
      font-weight: bold;
      font-size: 2rem;
      text-align: center;
      margin-bottom: 30px;
    }
    .btn-back {
      background: rgba(228, 165, 232, 0.8);
      color: #6b46a3;
      border: 2px solid #6b46a3;
      border-radius: 10px;
      padding: 10px 20px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      margin-bottom: 20px;
    }
    .btn-back:hover {
      background: #6b46a3;
      color: white;
      text-decoration: none;
    }
    .table-container {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 15px;
      overflow: hidden;
      border: 2px solid #e4a5e8;
      margin-top: 20px;
    }
    .table th {
      background: #6b46a3;
      color: white;
      font-weight: 600;
      padding: 15px;
      border: none;
    }
    .table td {
      padding: 15px;
      border-bottom: 1px solid #e4a5e8;
    }
    .section-title {
      color: #6b46a3;
      font-weight: 600;
      font-size: 1.5rem;
      margin: 30px 0 20px 0;
    }
    .account-detail {
      background: rgba(228, 165, 232, 0.1);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid #6b46a3;
    }
    .saldo-positivo {
      color: #28a745;
      font-weight: bold;
    }
    .saldo-negativo {
      color: #dc3545;
      font-weight: bold;
    }
    .saldo-cero {
      color: #6c757d;
      font-weight: bold;
    }
    .filter-section {
      background: rgba(228, 165, 232, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .btn-filter {
      background: #6b46a3;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      transition: all 0.3s ease;
    }
    .btn-filter:hover {
      background: #5a3a8a;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <a href="panel.html" class="btn-back">← Volver al Panel</a>
    
    <h1 class="page-title">Libro Mayor</h1>

    <!-- Filtros -->
    <div class="filter-section">
      <div class="row align-items-end">
        <div class="col-md-4">
          <label for="filtroTipo" class="form-label" style="color: #6b46a3; font-weight: 600;">Filtrar por tipo:</label>
          <select id="filtroTipo" class="form-control">
            <option value="todas">Todas las cuentas</option>
            <option value="activos">Solo Activos</option>
            <option value="pasivos">Solo Pasivos</option>
            <option value="ingresos">Solo Ingresos</option>
            <option value="gastos">Solo Gastos</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="filtroSaldo" class="form-label" style="color: #6b46a3; font-weight: 600;">Filtrar por saldo:</label>
          <select id="filtroSaldo" class="form-control">
            <option value="todos">Todos los saldos</option>
            <option value="positivos">Solo positivos</option>
            <option value="negativos">Solo negativos</option>
            <option value="cero">Solo en cero</option>
          </select>
        </div>
        <div class="col-md-4">
          <button onclick="aplicarFiltros()" class="btn btn-filter">Aplicar Filtros</button>
          <button onclick="limpiarFiltros()" class="btn btn-filter" style="background: #8e7cc3;">Limpiar</button>
        </div>
      </div>
    </div>

    <h2 class="section-title">Resumen de Cuentas</h2>
    <div class="table-container">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Cuenta</th>
              <th>Total Cargos</th>
              <th>Total Abonos</th>
              <th>Saldo Final</th>
              <th>Tipo de Cuenta</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="mayorTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Detalles de cuenta seleccionada -->
    <div id="detallesCuenta" class="account-detail" style="display: none;">
      <h3 style="color: #6b46a3;">Detalles de la Cuenta: <span id="nombreCuentaDetalle"></span></h3>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Cargo</th>
              <th>Abono</th>
              <th>Saldo Acumulado</th>
            </tr>
          </thead>
          <tbody id="detalleMovimientos"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let movimientosFiltrados = [];

    // Cargar libro mayor al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
      cargarLibroMayor();
    });

    function cargarLibroMayor() {
      const movimientos = JSON.parse(localStorage.getItem('movimientos')) || [];
      const cuentas = {};
      
      // Agrupar movimientos por cuenta
      movimientos.forEach(mov => {
        if (!cuentas[mov.cuenta]) {
          cuentas[mov.cuenta] = {
            nombre: mov.cuenta,
            movimientos: [],
            totalCargos: 0,
            totalAbonos: 0,
            saldoFinal: 0
          };
        }
        
        cuentas[mov.cuenta].movimientos.push(mov);
        cuentas[mov.cuenta].totalCargos += parseFloat(mov.cargo) || 0;
        cuentas[mov.cuenta].totalAbonos += parseFloat(mov.abono) || 0;
      });
      
      // Calcular saldos finales
      Object.keys(cuentas).forEach(cuenta => {
        cuentas[cuenta].saldoFinal = cuentas[cuenta].totalCargos - cuentas[cuenta].totalAbonos;
        cuentas[cuenta].tipo = determinarTipoCuenta(cuenta);
      });
      
      movimientosFiltrados = Object.values(cuentas);
      mostrarCuentas(movimientosFiltrados);
    }

    function determinarTipoCuenta(nombreCuenta) {
      const nombre = nombreCuenta.toLowerCase();
      if (nombre.includes('venta') || nombre.includes('ingreso') || nombre.includes('ganancia')) {
        return 'ingresos';
      } else if (nombre.includes('compra') || nombre.includes('gasto') || nombre.includes('costo')) {
        return 'gastos';
      } else if (nombre.includes('efectivo') || nombre.includes('banco') || nombre.includes('inventario')) {
        return 'activos';
      } else if (nombre.includes('deuda') || nombre.includes('préstamo') || nombre.includes('por pagar')) {
        return 'pasivos';
      }
      return 'otros';
    }

    function mostrarCuentas(cuentas) {
      const tbody = document.getElementById('mayorTable');
      tbody.innerHTML = '';
      
      if (cuentas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay cuentas que coincidan con los filtros</td></tr>';
        return;
      }
      
      // Ordenar por nombre de cuenta
      cuentas.sort((a, b) => a.nombre.localeCompare(b.nombre));
      
      cuentas.forEach(cuenta => {
        const row = document.createElement('tr');
        const saldoClass = cuenta.saldoFinal > 0 ? 'saldo-positivo' : 
                          cuenta.saldoFinal < 0 ? 'saldo-negativo' : 'saldo-cero';
        
        row.innerHTML = `
          <td><strong>${cuenta.nombre}</strong></td>
          <td>${cuenta.totalCargos.toFixed(2)}</td>
          <td>${cuenta.totalAbonos.toFixed(2)}</td>
          <td class="${saldoClass}">${cuenta.saldoFinal.toFixed(2)}</td>
          <td><span class="badge" style="background: #e4a5e8; color: #6b46a3;">${cuenta.tipo}</span></td>
          <td>
            <button class="btn btn-sm btn-filter" onclick="verDetallesCuenta('${cuenta.nombre}')">
              Ver Detalles
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function aplicarFiltros() {
      const filtroTipo = document.getElementById('filtroTipo').value;
      const filtroSaldo = document.getElementById('filtroSaldo').value;
      
      let cuentasFiltradas = [...movimientosFiltrados];
      
      // Filtrar por tipo
      if (filtroTipo !== 'todas') {
        cuentasFiltradas = cuentasFiltradas.filter(cuenta => cuenta.tipo === filtroTipo);
      }
      
      // Filtrar por saldo
      if (filtroSaldo !== 'todos') {
        switch(filtroSaldo) {
          case 'positivos':
            cuentasFiltradas = cuentasFiltradas.filter(cuenta => cuenta.saldoFinal > 0);
            break;
          case 'negativos':
            cuentasFiltradas = cuentasFiltradas.filter(cuenta => cuenta.saldoFinal < 0);
            break;
          case 'cero':
            cuentasFiltradas = cuentasFiltradas.filter(cuenta => cuenta.saldoFinal === 0);
            break;
        }
      }
      
      mostrarCuentas(cuentasFiltradas);
    }

    function limpiarFiltros() {
      document.getElementById('filtroTipo').value = 'todas';
      document.getElementById('filtroSaldo').value = 'todos';
      mostrarCuentas(movimientosFiltrados);
    }

    function verDetallesCuenta(nombreCuenta) {
      const cuenta = movimientosFiltrados.find(c => c.nombre === nombreCuenta);
      if (!cuenta) return;
      
      document.getElementById('nombreCuentaDetalle').textContent = nombreCuenta;
      const tbody = document.getElementById('detalleMovimientos');
      tbody.innerHTML = '';
      
      // Ordenar movimientos por fecha
      const movimientosOrdenados = [...cuenta.movimientos].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
      
      let saldoAcumulado = 0;
      
      movimientosOrdenados.forEach(mov => {
        const cargo = parseFloat(mov.cargo) || 0;
        const abono = parseFloat(mov.abono) || 0;
        saldoAcumulado += cargo - abono;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${mov.fecha}</td>
          <td>${cargo.toFixed(2)}</td>
          <td>${abono.toFixed(2)}</td>
          <td class="${saldoAcumulado >= 0 ? 'saldo-positivo' : 'saldo-negativo'}">
            ${saldoAcumulado.toFixed(2)}
          </td>
        `;
        tbody.appendChild(row);
      });
      
      document.getElementById('detallesCuenta').style.display = 'block';
      document.getElementById('detallesCuenta').scrollIntoView({ behavior: 'smooth' });
    }
  </script>
</body>
</html>