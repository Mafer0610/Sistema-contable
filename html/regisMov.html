<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registrar Movimientos - SKY HOME</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #b19cd9 0%, #c2a5db 50%, #d4b3e0 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .main-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      margin: 30px auto;
      padding: 40px;
      max-width: 1200px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .page-title {
      color: #6b46a3;
      font-weight: bold;
      font-size: 2rem;
      text-align: center;
      margin-bottom: 30px;
    }
    .form-control, .form-select {
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 12px 15px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.8);
    }
    .form-control:focus, .form-select:focus {
      border-color: #6b46a3;
      box-shadow: 0 0 0 0.2rem rgba(107, 70, 163, 0.25);
      background: rgba(255, 255, 255, 1);
    }
    .form-label {
      color: #6b46a3;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .btn-add-cuenta {
      background: rgba(228, 165, 232, 0.8);
      color: #6b46a3;
      border: 2px solid #6b46a3;
      border-radius: 10px;
      padding: 8px 15px;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    .btn-add-cuenta:hover {
      background: #6b46a3;
      color: white;
    }
    .btn-save {
      background: linear-gradient(135deg, #6b46a3, #8e7cc3);
      border: none;
      border-radius: 10px;
      padding: 12px;
      font-size: 1rem;
      font-weight: 600;
      color: white;
      transition: all 0.3s ease;
    }
    .btn-save:hover {
      background: linear-gradient(135deg, #5a3a8a, #7a6bb0);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(107, 70, 163, 0.4);
    }
    .btn-save:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .btn-back {
      background: rgba(228, 165, 232, 0.8);
      color: #6b46a3;
      border: 2px solid #6b46a3;
      border-radius: 10px;
      padding: 10px 20px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      margin-bottom: 20px;
    }
    .btn-back:hover {
      background: #6b46a3;
      color: white;
      text-decoration: none;
    }
    .cuentas-container {
      background: rgba(228, 165, 232, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
    }
    .cuenta-row {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      border: 2px solid #e4a5e8;
    }
    .balance-info {
      background: rgba(107, 70, 163, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
    }
    .balance-amount {
      font-size: 1.2rem;
      font-weight: bold;
      color: #6b46a3;
    }
    .table-container {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 15px;
      overflow: hidden;
      border: 2px solid #e4a5e8;
      margin-top: 30px;
    }
    .table th {
      background: #6b46a3;
      color: white;
      font-weight: 600;
      padding: 15px;
      border: none;
    }
    .table td {
      padding: 15px;
      border-bottom: 1px solid #e4a5e8;
    }
    .section-title {
      color: #6b46a3;
      font-weight: 600;
      font-size: 1.5rem;
      margin: 30px 0 20px 0;
    }
    .alert {
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
    }
    .btn-danger {
      background: #dc3545;
      border: none;
      border-radius: 8px;
      padding: 5px 15px;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <a href="panel.html" class="btn-back">← Volver al Panel</a>
    
    <h1 class="page-title">Nuevo Movimiento Contable</h1>
    
    <!-- Mensaje de estado -->
    <div id="statusMessage" style="display: none;"></div>
    
    <form id="movimientoForm">
      <div class="row">
        <div class="col-md-3">
          <div class="mb-3">
            <label for="fecha" class="form-label">Fecha</label>
            <input type="date" id="fecha" class="form-control" required>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label for="concepto" class="form-label">Concepto</label>
            <input type="text" id="concepto" class="form-control" placeholder="Descripción del movimiento" required>
          </div>
        </div>
        <div class="col-md-3">
          <div class="mb-3">
            <label for="referencia" class="form-label">Referencia</label>
            <input type="text" id="referencia" class="form-control" placeholder="Factura, recibo, etc.">
          </div>
        </div>
      </div>

      <div class="cuentas-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Cuentas del Movimiento</h5>
          <button type="button" class="btn-add-cuenta" onclick="agregarCuenta()">
            + Agregar Cuenta
          </button>
        </div>
        
        <div id="cuentasContainer">
          <!-- Las cuentas se agregan dinámicamente aquí -->
        </div>
        
        <div class="balance-info" id="balanceInfo">
          <div>Total Debe: <span id="totalDebe" class="balance-amount">$0.00</span></div>
          <div>Total Haber: <span id="totalHaber" class="balance-amount">$0.00</span></div>
          <div>Diferencia: <span id="diferencia" class="balance-amount">$0.00</span></div>
        </div>
      </div>
      
      <button type="submit" class="btn btn-save w-100" id="saveBtn">
        Guardar Movimiento
      </button>
    </form>

    <h2 class="section-title">Movimientos Registrados</h2>
    <div class="table-container">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Asiento</th>
              <th>Fecha</th>
              <th>Concepto</th>
              <th>Total Debe</th>
              <th>Total Haber</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="movimientosTable">
            <tr>
              <td colspan="6" class="text-center">Cargando movimientos...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Configuración de la API
    const API_BASE = window.location.origin + '/api';
    
    // Variables globales
    let cuentas = [];
    let movimientos = [];
    let contadorCuentas = 0;
    let authToken = null;

    // Verificar autenticación
    function checkAuth() {
      // Primero intentar con el método actual (localStorage simple)
      const loggedIn = localStorage.getItem('loggedIn');
      if (loggedIn === 'true') {
        return true;
      }
      
      // Si no, intentar con JWT
      authToken = localStorage.getItem('authToken');
      if (authToken) {
        return true;
      }
      
      showMessage('Sesión expirada. Redirigiendo al login...', 'warning');
      setTimeout(() => {
        window.location.href = 'login.html';
      }, 2000);
      return false;
    }

    // Función para mostrar mensajes
    function showMessage(message, type = 'info') {
      const messageDiv = document.getElementById('statusMessage');
      messageDiv.className = `alert alert-${type}`;
      messageDiv.textContent = message;
      messageDiv.style.display = 'block';
      
      if (type !== 'danger') {
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 4000);
      }
    }

    // Función para hacer peticiones autenticadas
    async function fetchWithAuth(url, options = {}) {
      // Si no hay authToken, usar modo localStorage
      if (!authToken) {
        return handleLocalStorageMode(url, options);
      }

      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`,
        ...options.headers
      };

      try {
        const response = await fetch(url, { ...options, headers });
        
        if (response.status === 401) {
          // Si falla JWT, intentar localStorage
          return handleLocalStorageMode(url, options);
        }
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Error del servidor' }));
          throw new Error(errorData.error || `Error HTTP ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('Error en petición:', error);
        // Fallback a localStorage
        return handleLocalStorageMode(url, options);
      }
    }

    // Manejar modo localStorage (compatibilidad con sistema actual)
    function handleLocalStorageMode(url, options) {
      if (url.includes('/cuentas') && options.method !== 'POST') {
        // Devolver catálogo de cuentas básico
        return Promise.resolve([
          { id: 1, codigo: '1001', nombre: 'Caja' },
          { id: 2, codigo: '1002', nombre: 'Bancos' },
          { id: 3, codigo: '1003', nombre: 'Clientes' },
          { id: 4, codigo: '1004', nombre: 'Inventarios' },
          { id: 5, codigo: '1005', nombre: 'Equipo de oficina' },
          { id: 6, codigo: '2001', nombre: 'Proveedores' },
          { id: 7, codigo: '2002', nombre: 'Acreedores diversos' },
          { id: 8, codigo: '3001', nombre: 'Capital social' },
          { id: 9, codigo: '4001', nombre: 'Ventas' },
          { id: 10, codigo: '5001', nombre: 'Compras' },
          { id: 11, codigo: '5002', nombre: 'Gastos de venta' },
          { id: 12, codigo: '5003', nombre: 'Gastos de administración' }
        ]);
      }
      
      if (url.includes('/movimientos') && options.method === 'POST') {
        // Guardar movimiento en localStorage (modo compatibilidad)
        return saveMovimientoToLocalStorage(JSON.parse(options.body));
      }
      
      if (url.includes('/movimientos') && !options.method) {
        // Cargar movimientos desde localStorage
        const movimientos = JSON.parse(localStorage.getItem('movimientos')) || [];
        return Promise.resolve(movimientos.map(mov => ({
          id: mov.id,
          numero_asiento: mov.asiento || mov.id,
          fecha: mov.fecha,
          concepto: mov.concepto,
          referencia: mov.referencia || '',
          totalDebe: mov.cargo || 0,
          totalHaber: mov.abono || 0,
          cuentas: [{ 
            codigo: mov.cuenta?.split(' - ')[0] || '', 
            nombre: mov.cuenta?.split(' - ')[1] || mov.cuenta || '',
            debe: mov.cargo || 0,
            haber: mov.abono || 0
          }]
        })));
      }
      
      return Promise.reject(new Error('Funcionalidad no disponible sin conexión a API'));
    }

    // Guardar movimiento en localStorage (modo compatibilidad)
    function saveMovimientoToLocalStorage(movimientoData) {
      const movimientos = JSON.parse(localStorage.getItem('movimientos')) || [];
      const currentUser = JSON.parse(localStorage.getItem('currentUser')) || { nombre: 'Usuario', apellidos: 'Sistema' };
      
      // Convertir formato API a formato localStorage
      let contadorMovimientos = movimientos.length + 1;
      
      movimientoData.cuentas.forEach((cuenta, index) => {
        const cuentaInfo = cuentas.find(c => c.id === cuenta.cuenta_id);
        const nuevoMovimiento = {
          id: contadorMovimientos + index,
          asiento: contadorMovimientos,
          fecha: movimientoData.fecha,
          cuenta: `${cuentaInfo?.codigo} - ${cuentaInfo?.nombre}` || 'Cuenta desconocida',
          concepto: movimientoData.concepto,
          referencia: movimientoData.referencia,
          cargo: cuenta.debe || 0,
          abono: cuenta.haber || 0,
          usuario: `${currentUser.nombre} ${currentUser.apellidos}`,
          timestamp: new Date().toISOString()
        };
        
        movimientos.push(nuevoMovimiento);
      });
      
      localStorage.setItem('movimientos', JSON.stringify(movimientos));
      
      return Promise.resolve({
        id: contadorMovimientos,
        numero_asiento: contadorMovimientos,
        fecha: movimientoData.fecha,
        concepto: movimientoData.concepto,
        referencia: movimientoData.referencia,
        cuentas: movimientoData.cuentas,
        totalDebe: movimientoData.cuentas.reduce((sum, c) => sum + (c.debe || 0), 0),
        totalHaber: movimientoData.cuentas.reduce((sum, c) => sum + (c.haber || 0), 0)
      });
    }

    // Cargar catálogo de cuentas
    async function loadCuentas() {
      try {
        const data = await fetchWithAuth(`${API_BASE}/cuentas`);
        if (data) {
          cuentas = data;
          console.log('Cuentas cargadas:', cuentas.length);
        }
      } catch (error) {
        console.error('Error cargando cuentas:', error);
        showMessage('Error cargando catálogo de cuentas: ' + error.message, 'danger');
      }
    }

    // Agregar nueva fila de cuenta
    function agregarCuenta() {
      contadorCuentas++;
      const container = document.getElementById('cuentasContainer');
      
      const cuentaRow = document.createElement('div');
      cuentaRow.className = 'cuenta-row';
      cuentaRow.id = `cuenta-${contadorCuentas}`;
      
      cuentaRow.innerHTML = `
        <div class="row align-items-center">
          <div class="col-md-6">
            <label class="form-label">Cuenta</label>
            <select class="form-select cuenta-select" required onchange="updateBalance()">
              <option value="">Seleccionar cuenta...</option>
              ${cuentas.map(cuenta => 
                `<option value="${cuenta.id}">${cuenta.codigo} - ${cuenta.nombre}</option>`
              ).join('')}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Debe</label>
            <input type="number" class="form-control debe-input" step="0.01" min="0" value="0" onchange="onDebeChange(this)" oninput="updateBalance()">
          </div>
          <div class="col-md-2">
            <label class="form-label">Haber</label>
            <input type="number" class="form-control haber-input" step="0.01" min="0" value="0" onchange="onHaberChange(this)" oninput="updateBalance()">
          </div>
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-danger w-100" onclick="eliminarCuenta(${contadorCuentas})">
              Eliminar
            </button>
          </div>
        </div>
      `;
      
      container.appendChild(cuentaRow);
      updateBalance();
    }

    // Eliminar cuenta
    function eliminarCuenta(id) {
      const element = document.getElementById(`cuenta-${id}`);
      if (element) {
        element.remove();
        updateBalance();
      }
    }

    // Manejar cambio en debe
    function onDebeChange(input) {
      if (parseFloat(input.value) > 0) {
        const haberInput = input.closest('.cuenta-row').querySelector('.haber-input');
        haberInput.value = 0;
      }
      updateBalance();
    }

    // Manejar cambio en haber
    function onHaberChange(input) {
      if (parseFloat(input.value) > 0) {
        const debeInput = input.closest('.cuenta-row').querySelector('.debe-input');
        debeInput.value = 0;
      }
      updateBalance();
    }

    // Actualizar balance
    function updateBalance() {
      const debeInputs = document.querySelectorAll('.debe-input');
      const haberInputs = document.querySelectorAll('.haber-input');
      
      let totalDebe = 0;
      let totalHaber = 0;
      
      debeInputs.forEach(input => {
        totalDebe += parseFloat(input.value) || 0;
      });
      
      haberInputs.forEach(input => {
        totalHaber += parseFloat(input.value) || 0;
      });
      
      const diferencia = totalDebe - totalHaber;
      
      document.getElementById('totalDebe').textContent = '
       + totalDebe.toFixed(2);
      document.getElementById('totalHaber').textContent = '
       + totalHaber.toFixed(2);
      document.getElementById('diferencia').textContent = '
       + diferencia.toFixed(2);
      
      // Cambiar color según el balance
      const diferenciaEl = document.getElementById('diferencia');
      if (Math.abs(diferencia) < 0.01) {
        diferenciaEl.style.color = '#28a745'; // Verde si está balanceado
      } else {
        diferenciaEl.style.color = '#dc3545'; // Rojo si no está balanceado
      }
    }

    // Guardar movimiento
    async function guardarMovimiento(e) {
      e.preventDefault();
      
      try {
        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.textContent;
        saveBtn.innerHTML = '<span class="loading-spinner"></span>Guardando...';
        saveBtn.disabled = true;
        
        const fecha = document.getElementById('fecha').value;
        const concepto = document.getElementById('concepto').value;
        const referencia = document.getElementById('referencia').value;
        
        // Validaciones básicas
        if (!fecha || !concepto) {
          throw new Error('Fecha y concepto son obligatorios');
        }
        
        // Recopilar cuentas
        const cuentasRows = document.querySelectorAll('.cuenta-row');
        const cuentasData = [];
        
        cuentasRows.forEach(row => {
          const cuentaSelect = row.querySelector('.cuenta-select');
          const debeInput = row.querySelector('.debe-input');
          const haberInput = row.querySelector('.haber-input');
          
          const cuenta_id = parseInt(cuentaSelect.value);
          const debe = parseFloat(debeInput.value) || 0;
          const haber = parseFloat(haberInput.value) || 0;
          
          if (cuenta_id && (debe > 0 || haber > 0)) {
            cuentasData.push({ cuenta_id, debe, haber });
          }
        });
        
        // Validaciones del movimiento
        if (cuentasData.length < 2) {
          throw new Error('Debe incluir al menos 2 cuentas');
        }
        
        const totalDebe = cuentasData.reduce((sum, c) => sum + c.debe, 0);
        const totalHaber = cuentasData.reduce((sum, c) => sum + c.haber, 0);
        
        if (Math.abs(totalDebe - totalHaber) > 0.01) {
          throw new Error('El asiento no está balanceado (Debe ≠ Haber)');
        }
        
        // Enviar a la API
        const movimientoData = {
          fecha,
          concepto,
          referencia: referencia || '',
          cuentas: cuentasData,
          empresaId: 1 // Por defecto empresa 1
        };
        
        const result = await fetchWithAuth(`${API_BASE}/movimientos`, {
          method: 'POST',
          body: JSON.stringify(movimientoData)
        });
        
        if (result) {
          showMessage('Movimiento guardado exitosamente', 'success');
          
          // Limpiar formulario
          document.getElementById('movimientoForm').reset();
          document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
          document.getElementById('cuentasContainer').innerHTML = '';
          contadorCuentas = 0;
          updateBalance();
          
          // Agregar dos cuentas por defecto
          agregarCuenta();
          agregarCuenta();
          
          // Recargar tabla de movimientos
          await loadMovimientos();
        }
        
      } catch (error) {
        console.error('Error guardando movimiento:', error);
        showMessage('Error: ' + error.message, 'danger');
      } finally {
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.textContent = 'Guardar Movimiento';
        saveBtn.disabled = false;
      }
    }

    // Cargar movimientos
    async function loadMovimientos() {
      try {
        const data = await fetchWithAuth(`${API_BASE}/movimientos`);
        if (data) {
          movimientos = data;
          renderMovimientos();
        }
      } catch (error) {
        console.error('Error cargando movimientos:', error);
        showMessage('Error cargando movimientos: ' + error.message, 'danger');
      }
    }

    // Renderizar movimientos en la tabla
    function renderMovimientos() {
      const tbody = document.getElementById('movimientosTable');
      tbody.innerHTML = '';
      
      if (movimientos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay movimientos registrados</td></tr>';
        return;
      }
      
      // Mostrar los últimos 10 movimientos
      const movimientosRecientes = movimientos.slice(0, 10);
      
      movimientosRecientes.forEach((mov) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${mov.numero_asiento}</td>
          <td>${new Date(mov.fecha).toLocaleDateString('es-MX')}</td>
          <td>${mov.concepto}</td>
          <td class="text-end">${mov.totalDebe.toFixed(2)}</td>
          <td class="text-end">${mov.totalHaber.toFixed(2)}</td>
          <td>
            <button class="btn btn-sm btn-info me-2" onclick="verDetalleMovimiento(${mov.id})" title="Ver detalle">
              Ver
            </button>
            <button class="btn btn-sm btn-danger" onclick="eliminarMovimiento(${mov.id})" title="Eliminar">
              Eliminar
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Ver detalle del movimiento
    function verDetalleMovimiento(id) {
      const movimiento = movimientos.find(m => m.id === id);
      if (!movimiento) return;
      
      let detalleHtml = `
        <strong>Asiento:</strong> ${movimiento.numero_asiento}<br>
        <strong>Fecha:</strong> ${new Date(movimiento.fecha).toLocaleDateString('es-MX')}<br>
        <strong>Concepto:</strong> ${movimiento.concepto}<br>
        <strong>Referencia:</strong> ${movimiento.referencia || 'N/A'}<br><br>
        <strong>Cuentas:</strong><br>
      `;
      
      movimiento.cuentas.forEach(cuenta => {
        detalleHtml += `- ${cuenta.codigo} - ${cuenta.nombre}: `;
        if (cuenta.debe > 0) {
          detalleHtml += `Debe ${cuenta.debe.toFixed(2)}<br>`;
        } else {
          detalleHtml += `Haber ${cuenta.haber.toFixed(2)}<br>`;
        }
      });
      
      const modal = document.createElement('div');
      modal.innerHTML = `
        <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" onclick="this.remove()">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Detalle del Movimiento</h5>
                <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
              </div>
              <div class="modal-body">
                ${detalleHtml}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cerrar</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // Eliminar movimiento
    async function eliminarMovimiento(id) {
      if (!confirm('¿Está seguro de eliminar este movimiento?')) return;
      
      try {
        await fetchWithAuth(`${API_BASE}/movimientos/${id}`, {
          method: 'DELETE'
        });
        
        showMessage('Movimiento eliminado correctamente', 'success');
        await loadMovimientos();
      } catch (error) {
        console.error('Error eliminando movimiento:', error);
        showMessage('Error eliminando movimiento: ' + error.message, 'danger');
      }
    }

    // Inicialización
    document.addEventListener('DOMContentLoaded', async function() {
      if (!checkAuth()) return;

      // Establecer fecha actual por defecto
      document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
      
      // Event listeners
      document.getElementById('movimientoForm').addEventListener('submit', guardarMovimiento);
      
      // Cargar datos
      await loadCuentas();
      await loadMovimientos();
      
      // Agregar dos cuentas por defecto
      agregarCuenta();
      agregarCuenta();
    });

    // Exponer funciones globalmente para onclick
    window.agregarCuenta = agregarCuenta;
    window.eliminarCuenta = eliminarCuenta;
    window.onDebeChange = onDebeChange;
    window.onHaberChange = onHaberChange;
    window.verDetalleMovimiento = verDetalleMovimiento;
    window.eliminarMovimiento = eliminarMovimiento;
  </script>
</body>
</html>