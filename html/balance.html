<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Balance General - Sky Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #b19cd9 0%, #c2a5db 50%, #d4b3e0 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .main-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      margin: 30px auto;
      padding: 40px;
      max-width: 1200px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .page-title {
      color: #6b46a3;
      font-weight: bold;
      font-size: 1.8rem;
      text-align: center;
      margin-bottom: 5px;
    }
    .company-info {
      text-align: center;
      color: #8e7cc3;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    .date-info {
      text-align: center;
      color: #8e7cc3;
      margin-bottom: 30px;
      font-size: 1rem;
    }
    .btn-back {
      background: rgba(228, 165, 232, 0.8);
      color: #6b46a3;
      border: 2px solid #6b46a3;
      border-radius: 10px;
      padding: 10px 20px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      margin-bottom: 20px;
    }
    .btn-back:hover {
      background: #6b46a3;
      color: white;
      text-decoration: none;
    }
    .controls {
      background: rgba(228, 165, 232, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .btn-generate {
      background: linear-gradient(135deg, #6b46a3, #8e7cc3);
      border: none;
      border-radius: 10px;
      padding: 12px 30px;
      font-size: 1rem;
      font-weight: 600;
      color: white;
      transition: all 0.3s ease;
      margin: 0 10px;
    }
    .btn-generate:hover {
      background: linear-gradient(135deg, #5a3a8a, #7a6bb0);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(107, 70, 163, 0.4);
    }
    .btn-generate:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .btn-print {
      background: rgba(228, 165, 232, 0.8);
      color: #6b46a3;
      border: 2px solid #6b46a3;
      border-radius: 10px;
      padding: 10px 25px;
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 0 10px;
    }
    .btn-print:hover {
      background: #6b46a3;
      color: white;
    }
    .balance-wrapper {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      border: 2px solid #6b46a3;
      margin-bottom: 20px;
    }
    .balance-table {
      width: 100%;
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }
    .balance-table th,
    .balance-table td {
      padding: 8px 12px;
      border: 1px solid #6b46a3;
      text-align: left;
      vertical-align: top;
    }
    .header-empresa {
      background: #6b46a3;
      color: white;
      font-weight: bold;
      text-align: center;
      font-size: 1rem;
    }
    .header-titulo {
      background: #8e7cc3;
      color: white;
      font-weight: bold;
      text-align: center;
      font-size: 0.95rem;
    }
    .header-columns {
      background: #d4b3e0;
      color: #6b46a3;
      font-weight: bold;
      text-align: center;
      font-size: 0.85rem;
    }
    .section-title {
      background: #f0f0f0;
      font-weight: bold;
      text-align: center;
    }
    .account-name {
      padding-left: 20px;
    }
    .amount {
      text-align: right;
      font-weight: normal;
    }
    .total-row {
      font-weight: bold;
      background: #f8f9fa;
    }
    .grand-total {
      font-weight: bold;
      background: #e9ecef;
      border-top: 2px solid #6b46a3;
    }
    .form-control, .form-select {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 8px 12px;
      transition: all 0.3s ease;
    }
    .form-control:focus, .form-select:focus {
      border-color: #6b46a3;
      box-shadow: 0 0 0 0.2rem rgba(107, 70, 163, 0.25);
    }
    .no-data-message {
      text-align: center;
      padding: 40px;
      color: #8e7cc3;
      font-size: 1.2rem;
    }
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .summary-card {
      background: rgba(228, 165, 232, 0.1);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      border: 2px solid #e4a5e8;
    }
    .summary-title {
      color: #6b46a3;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .summary-amount {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
    }
    .alert {
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
    }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @media print {
      body { background: white; }
      .main-container { background: white; box-shadow: none; border: none; }
      .btn-back, .controls, .summary-cards { display: none; }
      .balance-table { font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <a href="panel.html" class="btn-back">← Volver al Panel</a>
    
    <!-- Mensaje de estado -->
    <div id="statusMessage" style="display: none;"></div>
    
    <div class="controls">
      <div class="row align-items-end">
        <div class="col-md-4">
          <label for="empresaSelect" class="form-label">Empresa:</label>
          <select id="empresaSelect" class="form-select">
            <option value="">Cargando empresas...</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="fechaCorte" class="form-label">Fecha de Corte:</label>
          <input type="date" id="fechaCorte" class="form-control">
        </div>
        <div class="col-md-4">
          <div class="d-flex gap-2">
            <button id="generateBtn" class="btn-generate">
              Generar Balance
            </button>
            <button id="printBtn" class="btn-print" onclick="window.print()">Imprimir</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Resumen de saldos -->
    <div id="summaryCards" class="summary-cards" style="display: none;">
      <div class="summary-card">
        <div class="summary-title">Total Activos</div>
        <div class="summary-amount" id="totalActivos">$0.00</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Total Pasivos</div>
        <div class="summary-amount" id="totalPasivos">$0.00</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Total Capital</div>
        <div class="summary-amount" id="totalCapital">$0.00</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Diferencia</div>
        <div class="summary-amount" id="diferencia">$0.00</div>
      </div>
    </div>

    <div id="balanceContent" class="balance-wrapper" style="display: none;">
      <table class="balance-table">
        <thead>
          <tr class="header-empresa">
            <td colspan="4" id="empresaNombre">Sky Home S.A. de C.V.</td>
          </tr>
          <tr class="header-titulo">
            <td colspan="4">Balance General al <span id="fechaBalance">fecha</span></td>
          </tr>
          <tr class="header-columns">
            <td width="25%">Activo</td>
            <td width="25%">Importe</td>
            <td width="25%">Pasivo y Capital</td>
            <td width="25%">Importe</td>
          </tr>
        </thead>
        <tbody id="balanceBody">
          <!-- Contenido dinámico -->
        </tbody>
      </table>
    </div>

    <!-- Mensaje cuando no hay datos -->
    <div id="noDataMessage" class="no-data-message">
      <p>No hay movimientos registrados para generar el balance.</p>
      <p>Primero registre algunos movimientos contables desde <a href="regisMov.html">Nuevo Movimiento</a></p>
    </div>
  </div>

  <script>
    // Configuración de la API
    const API_BASE = window.location.origin + '/api';
    
    // Variables globales
    let empresas = [];
    let authToken = null;

    // Verificar autenticación
    function checkAuth() {
      // Primero intentar con el método actual (localStorage simple)
      const loggedIn = localStorage.getItem('loggedIn');
      if (loggedIn === 'true') {
        return true;
      }
      
      // Si no, intentar con JWT
      authToken = localStorage.getItem('authToken');
      if (authToken) {
        return true;
      }
      
      showMessage('Sesión expirada. Redirigiendo al login...', 'warning');
      setTimeout(() => {
        window.location.href = 'login.html';
      }, 2000);
      return false;
    }

    // Función para mostrar mensajes
    function showMessage(message, type = 'info') {
      const messageDiv = document.getElementById('statusMessage');
      messageDiv.className = `alert alert-${type}`;
      messageDiv.textContent = message;
      messageDiv.style.display = 'block';
      
      if (type !== 'danger') {
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 4000);
      }
    }

    // Función para hacer peticiones autenticadas
    async function fetchWithAuth(url, options = {}) {
      // Si no hay authToken, intentar hacer la petición sin autenticación
      if (!authToken) {
        try {
          const response = await fetch(url, options);
          if (response.ok) {
            return await response.json();
          } else {
            // Si falla sin auth, intentar generar datos desde localStorage
            return generateMockDataFromLocalStorage(url);
          }
        } catch (error) {
          return generateMockDataFromLocalStorage(url);
        }
      }

      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`,
        ...options.headers
      };

      try {
        const response = await fetch(url, { ...options, headers });
        
        if (response.status === 401) {
          // Si falla JWT, intentar sin autenticación
          try {
            const fallbackResponse = await fetch(url, options);
            if (fallbackResponse.ok) {
              return await fallbackResponse.json();
            } else {
              return generateMockDataFromLocalStorage(url);
            }
          } catch {
            return generateMockDataFromLocalStorage(url);
          }
        }
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Error del servidor' }));
          throw new Error(errorData.error || `Error HTTP ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('Error en petición:', error);
        return generateMockDataFromLocalStorage(url);
      }
    }

    // Generar datos mock desde localStorage para compatibilidad
    function generateMockDataFromLocalStorage(url) {
      const movimientos = JSON.parse(localStorage.getItem('movimientos')) || [];
      
      if (url.includes('/empresas')) {
        return [{ id: 1, nombre: 'Sky Home S.A. de C.V.' }];
      }
      
      if (url.includes('/balance-general')) {
        return generateBalanceFromMovimientos(movimientos);
      }
      
      return null;
    }

    // Generar balance desde movimientos de localStorage
    function generateBalanceFromMovimientos(movimientos) {
      const fechaCorte = document.getElementById('fechaCorte').value;
      
      // Filtrar movimientos hasta la fecha de corte
      const movimientosFiltrados = movimientos.filter(mov => mov.fecha <= fechaCorte);
      
      if (movimientosFiltrados.length === 0) {
        return { activo: { total: 0, circulante: [], fijo: [] }, pasivo: { total: 0, corto_plazo: [], largo_plazo: [] }, capital: { total: 0, cuentas: [] } };
      }

      // Calcular saldos por cuenta
      const saldos = {};
      movimientosFiltrados.forEach(mov => {
        const cuenta = mov.cuenta || 'Sin clasificar';
        if (!saldos[cuenta]) {
          saldos[cuenta] = { debe: 0, haber: 0 };
        }
        saldos[cuenta].debe += mov.cargo || 0;
        saldos[cuenta].haber += mov.abono || 0;
      });

      const balance = {
        activo: { total: 0, circulante: [], fijo: [] },
        pasivo: { total: 0, corto_plazo: [], largo_plazo: [] },
        capital: { total: 0, cuentas: [] }
      };

      Object.entries(saldos).forEach(([cuenta, valores]) => {
        const saldo = valores.debe - valores.haber;
        
        if (Math.abs(saldo) > 0.01) { // Solo cuentas con saldo significativo
          const item = { codigo: cuenta, nombre: cuenta, saldo: Math.abs(saldo) };
          
          if (cuenta.startsWith('1') || cuenta.includes('Caja') || cuenta.includes('Bancos') || cuenta.includes('Clientes') || cuenta.includes('Inventarios')) {
            // Activos
            if (saldo > 0) {
              balance.activo.circulante.push(item);
              balance.activo.total += Math.abs(saldo);
            }
          } else if (cuenta.startsWith('2') || cuenta.includes('Proveedores') || cuenta.includes('Acreedores')) {
            // Pasivos
            if (saldo < 0) {
              balance.pasivo.corto_plazo.push(item);
              balance.pasivo.total += Math.abs(saldo);
            }
          } else if (cuenta.startsWith('3') || cuenta.includes('Capital')) {
            // Capital
            balance.capital.cuentas.push(item);
            balance.capital.total += Math.abs(saldo);
          } else if (cuenta.startsWith('4') || cuenta.includes('Ventas') || cuenta.includes('Ingresos')) {
            // Ingresos (van al capital)
            if (saldo < 0) {
              balance.capital.cuentas.push({ ...item, nombre: 'Utilidad por ' + cuenta });
              balance.capital.total += Math.abs(saldo);
            }
          } else if (cuenta.startsWith('5') || cuenta.includes('Gastos') || cuenta.includes('Compras')) {
            // Gastos (reducen el capital)
            if (saldo > 0) {
              balance.capital.cuentas.push({ ...item, nombre: 'Pérdida por ' + cuenta, saldo: -Math.abs(saldo) });
              balance.capital.total -= Math.abs(saldo);
            }
          }
        }
      });

      return balance;
    }

    // Cargar empresas
    async function loadEmpresas() {
      try {
        const data = await fetchWithAuth(`${API_BASE}/empresas`);
        if (data) {
          empresas = data;
          const select = document.getElementById('empresaSelect');
          select.innerHTML = '<option value="">Todas las empresas</option>';
          
          empresas.forEach(empresa => {
            const option = document.createElement('option');
            option.value = empresa.id;
            option.textContent = empresa.nombre;
            select.appendChild(option);
          });

          // Seleccionar la primera empresa por defecto
          if (empresas.length > 0) {
            select.value = empresas[0].id;
          }
        }
      } catch (error) {
        console.error('Error cargando empresas:', error);
        showMessage('Error cargando empresas: ' + error.message, 'danger');
      }
    }

    // Obtener balance general desde la API
    async function getBalanceGeneral() {
      try {
        const empresaId = document.getElementById('empresaSelect').value;
        const fechaCorte = document.getElementById('fechaCorte').value;

        if (!fechaCorte) {
          throw new Error('Por favor seleccione una fecha de corte');
        }

        let url = `${API_BASE}/balance-general?fechaCorte=${fechaCorte}`;
        if (empresaId) {
          url += `&empresaId=${empresaId}`;
        }

        const balance = await fetchWithAuth(url);
        return balance;
      } catch (error) {
        throw error;
      }
    }

    // Renderizar balance en la tabla
    function renderBalance(balance) {
      // Actualizar nombre de empresa
      const empresaId = document.getElementById('empresaSelect').value;
      let empresaNombre = 'Consolidado - Todas las Empresas';
      
      if (empresaId) {
        const empresa = empresas.find(e => e.id == empresaId);
        if (empresa) {
          empresaNombre = empresa.nombre;
        }
      }
      
      document.getElementById('empresaNombre').textContent = empresaNombre;

      // Actualizar fecha en el header
      const fechaCorte = document.getElementById('fechaCorte').value;
      const fecha = new Date(fechaCorte + 'T00:00:00');
      document.getElementById('fechaBalance').textContent = fecha.toLocaleDateString('es-MX', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });

      // Calcular totales
      const totalActivos = balance.activo.total || 0;
      const totalPasivos = balance.pasivo.total || 0;
      const totalCapital = balance.capital.total || 0;
      const totalPasivoCapital = totalPasivos + totalCapital;

      // Actualizar cards de resumen
      document.getElementById('totalActivos').textContent = '$' + totalActivos.toLocaleString('es-MX', {minimumFractionDigits: 2});
      document.getElementById('totalPasivos').textContent = '$' + totalPasivos.toLocaleString('es-MX', {minimumFractionDigits: 2});
      document.getElementById('totalCapital').textContent = '$' + totalCapital.toLocaleString('es-MX', {minimumFractionDigits: 2});
      document.getElementById('diferencia').textContent = '$' + (totalActivos - totalPasivoCapital).toLocaleString('es-MX', {minimumFractionDigits: 2});
      
      // Mostrar cards de resumen
      document.getElementById('summaryCards').style.display = 'grid';

      // Renderizar tabla
      const tbody = document.getElementById('balanceBody');
      tbody.innerHTML = '';

      // Preparar datos para la tabla
      const activosData = [
        ...balance.activo.circulante.map(item => ({...item, seccion: 'ACTIVO CIRCULANTE'})),
        ...balance.activo.fijo.map(item => ({...item, seccion: 'ACTIVO FIJO'}))
      ];

      const pasivosData = [
        ...balance.pasivo.corto_plazo.map(item => ({...item, seccion: 'PASIVO A CORTO PLAZO'})),
        ...balance.pasivo.largo_plazo.map(item => ({...item, seccion: 'PASIVO A LARGO PLAZO'}))
      ];

      const capitalData = balance.capital.cuentas.map(item => ({...item, seccion: 'CAPITAL'}));

      // Determinar número máximo de filas
      const maxRows = Math.max(
        activosData.length + (balance.activo.circulante.length > 0 ? 1 : 0) + (balance.activo.fijo.length > 0 ? 1 : 0) + 1,
        pasivosData.length + capitalData.length + (balance.pasivo.corto_plazo.length > 0 ? 1 : 0) + (balance.pasivo.largo_plazo.length > 0 ? 1 : 0) + (capitalData.length > 0 ? 1 : 0) + 2
      );

      let activoIndex = 0;
      let pasivoIndex = 0;
      let capitalIndex = 0;
      let currentActivoSection = '';
      let currentPasivoSection = '';
      let currentCapitalSection = '';

      for (let i = 0; i < maxRows; i++) {
        const row = document.createElement('tr');
        
        // Columna Activo
        let activoCell = '';
        let activoAmount = '';
        
        if (activoIndex < activosData.length) {
          const activo = activosData[activoIndex];
          
          // Mostrar título de sección si cambió
          if (currentActivoSection !== activo.seccion) {
            activoCell = activo.seccion;
            activoAmount = '';
            currentActivoSection = activo.seccion;
            row.className = 'section-title';
          } else {
            activoCell = activo.nombre;
            activoAmount = '$' + activo.saldo.toLocaleString('es-MX', { minimumFractionDigits: 2 });
            activoIndex++;
          }
        } else if (i === activosData.length + (balance.activo.circulante.length > 0 ? 1 : 0) + (balance.activo.fijo.length > 0 ? 1 : 0)) {
          activoCell = 'TOTAL ACTIVOS';
          activoAmount = '$' + totalActivos.toLocaleString('es-MX', { minimumFractionDigits: 2 });
          row.className = 'total-row';
        }

        // Columnas Pasivo y Capital
        let pasivoCapitalCell = '';
        let pasivoCapitalAmount = '';
        
        const totalPasivoItems = pasivosData.length;
        const totalCapitalItems = capitalData.length;
        
        if (pasivoIndex < totalPasivoItems) {
          const pasivo = pasivosData[pasivoIndex];
          
          if (currentPasivoSection !== pasivo.seccion) {
            pasivoCapitalCell = pasivo.seccion;
            pasivoCapitalAmount = '';
            currentPasivoSection = pasivo.seccion;
            row.className = 'section-title';
          } else {
            pasivoCapitalCell = pasivo.nombre;
            pasivoCapitalAmount = '$' + pasivo.saldo.toLocaleString('es-MX', { minimumFractionDigits: 2 });
            pasivoIndex++;
          }
        } else if (pasivoIndex === totalPasivoItems && totalPasivos > 0) {
          pasivoCapitalCell = 'Total Pasivos';
          pasivoCapitalAmount = '$' + totalPasivos.toLocaleString('es-MX', { minimumFractionDigits: 2 });
          pasivoIndex++;
          row.className = 'total-row';
        } else if (capitalIndex < totalCapitalItems) {
          const capital = capitalData[capitalIndex];
          
          if (currentCapitalSection !== capital.seccion) {
            pasivoCapitalCell = capital.seccion;
            pasivoCapitalAmount = '';
            currentCapitalSection = capital.seccion;
            row.className = 'section-title';
          } else {
            pasivoCapitalCell = capital.nombre;
            pasivoCapitalAmount = '$' + capital.saldo.toLocaleString('es-MX', { minimumFractionDigits: 2 });
            capitalIndex++;
          }
        } else if (capitalIndex === totalCapitalItems && totalCapital > 0) {
          pasivoCapitalCell = 'Total Capital';
          pasivoCapitalAmount = '$' + totalCapital.toLocaleString('es-MX', { minimumFractionDigits: 2 });
          capitalIndex++;
          row.className = 'total-row';
        } else if (i === maxRows - 1) {
          pasivoCapitalCell = 'TOTAL PASIVO + CAPITAL';
          pasivoCapitalAmount = '$' + totalPasivoCapital.toLocaleString('es-MX', { minimumFractionDigits: 2 });
          row.className = 'grand-total';
        }

        // Aplicar clases CSS
        const activoCellClass = (activoCell.includes('TOTAL') || activoCell.includes('ACTIVO')) ? '' : 'account-name';
        const pasivoCellClass = (pasivoCapitalCell.includes('TOTAL') || pasivoCapitalCell.includes('PASIVO') || pasivoCapitalCell.includes('CAPITAL')) ? '' : 'account-name';

        row.innerHTML = `<td class="${activoCellClass}">${activoCell}</td>` +
                       `<td class="amount">${activoAmount}</td>` +
                       `<td class="${pasivoCellClass}">${pasivoCapitalCell}</td>` +
                       `<td class="amount">${pasivoCapitalAmount}</td>`;

        tbody.appendChild(row);
      }

      // Mostrar el balance
      document.getElementById('balanceContent').style.display = 'block';
      document.getElementById('noDataMessage').style.display = 'none';
    }

    // Generar balance general
    async function generarBalance() {
      try {
        const btn = document.getElementById('generateBtn');
        const originalText = btn.textContent;
        
        // Mostrar loading
        btn.innerHTML = '<span class="loading-spinner"></span>Generando...';
        btn.disabled = true;

        const balance = await getBalanceGeneral();
        
        if (!balance || (!balance.activo?.total && !balance.pasivo?.total && !balance.capital?.total)) {
          document.getElementById('noDataMessage').style.display = 'block';
          document.getElementById('balanceContent').style.display = 'none';
          document.getElementById('summaryCards').style.display = 'none';
          showMessage('No hay movimientos registrados para la fecha seleccionada', 'warning');
          return;
        }

        renderBalance(balance);
        showMessage('Balance generado correctamente', 'success');
        
      } catch (error) {
        console.error('Error generando balance:', error);
        showMessage('Error generando el balance: ' + error.message, 'danger');
        document.getElementById('noDataMessage').style.display = 'block';
        document.getElementById('balanceContent').style.display = 'none';
        document.getElementById('summaryCards').style.display = 'none';
      } finally {
        const btn = document.getElementById('generateBtn');
        btn.textContent = 'Generar Balance';
        btn.disabled = false;
      }
    }

    // Inicialización
    document.addEventListener('DOMContentLoaded', async function() {
      if (!checkAuth()) return;

      // Establecer fecha actual por defecto
      const today = new Date();
      document.getElementById('fechaCorte').value = today.toISOString().split('T')[0];
      
      // Event listeners
      document.getElementById('generateBtn').addEventListener('click', generarBalance);
      
      // Cargar datos iniciales
      await loadEmpresas();
      
      // Auto-generar si hay empresas
      if (empresas.length > 0) {
        setTimeout(() => generarBalance(), 1000);
      }
    });
  </script>
</body>
</html>