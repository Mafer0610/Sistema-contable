<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Balance General - Sky Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #b19cd9 0%, #c2a5db 50%, #d4b3e0 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .main-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      margin: 30px auto;
      padding: 40px;
      max-width: 1200px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .page-title {
      color: #6b46a3;
      font-weight: bold;
      font-size: 1.8rem;
      text-align: center;
      margin-bottom: 5px;
    }
    .company-info {
      text-align: center;
      color: #8e7cc3;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    .date-info {
      text-align: center;
      color: #8e7cc3;
      margin-bottom: 30px;
      font-size: 1rem;
    }
    .btn-back {
      background: rgba(228, 165, 232, 0.8);
      color: #6b46a3;
      border: 2px solid #6b46a3;
      border-radius: 10px;
      padding: 10px 20px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      margin-bottom: 20px;
    }
    .btn-back:hover {
      background: #6b46a3;
      color: white;
      text-decoration: none;
    }
    .controls {
      background: rgba(228, 165, 232, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .btn-generate {
      background: linear-gradient(135deg, #6b46a3, #8e7cc3);
      border: none;
      border-radius: 10px;
      padding: 12px 30px;
      font-size: 1rem;
      font-weight: 600;
      color: white;
      transition: all 0.3s ease;
      margin: 0 10px;
    }
    .btn-generate:hover {
      background: linear-gradient(135deg, #5a3a8a, #7a6bb0);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(107, 70, 163, 0.4);
    }
    .btn-generate:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .btn-print {
      background: rgba(228, 165, 232, 0.8);
      color: #6b46a3;
      border: 2px solid #6b46a3;
      border-radius: 10px;
      padding: 10px 25px;
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 0 10px;
    }
    .btn-print:hover {
      background: #6b46a3;
      color: white;
    }
    .balance-wrapper {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      border: 2px solid #6b46a3;
      margin-bottom: 20px;
    }
    .balance-table {
      width: 100%;
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }
    .balance-table th,
    .balance-table td {
      padding: 8px 12px;
      border: 1px solid #6b46a3;
      text-align: left;
      vertical-align: top;
    }
    .header-empresa {
      background: #6b46a3;
      color: white;
      font-weight: bold;
      text-align: center;
      font-size: 1rem;
    }
    .header-titulo {
      background: #8e7cc3;
      color: white;
      font-weight: bold;
      text-align: center;
      font-size: 0.95rem;
    }
    .header-columns {
      background: #d4b3e0;
      color: #6b46a3;
      font-weight: bold;
      text-align: center;
      font-size: 0.85rem;
    }
    .section-title {
      background: #f0f0f0;
      font-weight: bold;
      text-align: center;
    }
    .account-name {
      padding-left: 20px;
    }
    .amount {
      text-align: right;
      font-weight: normal;
    }
    .total-row {
      font-weight: bold;
      background: #f8f9fa;
    }
    .grand-total {
      font-weight: bold;
      background: #e9ecef;
      border-top: 2px solid #6b46a3;
    }
    .form-control, .form-select {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 8px 12px;
      transition: all 0.3s ease;
    }
    .form-control:focus, .form-select:focus {
      border-color: #6b46a3;
      box-shadow: 0 0 0 0.2rem rgba(107, 70, 163, 0.25);
    }
    .no-data-message {
      text-align: center;
      padding: 40px;
      color: #8e7cc3;
      font-size: 1.2rem;
    }
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .summary-card {
      background: rgba(228, 165, 232, 0.1);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      border: 2px solid #e4a5e8;
    }
    .summary-title {
      color: #6b46a3;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .summary-amount {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
    }
    .alert {
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
    }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .debug-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }
    @media print {
      body { background: white; }
      .main-container { background: white; box-shadow: none; border: none; }
      .btn-back, .controls, .summary-cards, .debug-info { display: none; }
      .balance-table { font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <a href="panel.html" class="btn-back">← Volver al Panel</a>
    
    <!-- Mensaje de estado -->
    <div id="statusMessage" style="display: none;"></div>
    
    <!-- Debug Info -->
    <div id="debugInfo" class="debug-info" style="display: none;">
      <h6>Información de Debug:</h6>
      <div id="debugContent"></div>
    </div>
    
    <div class="controls">
      <div class="row align-items-end">
        <div class="col-md-3">
          <label for="empresaSelect" class="form-label">Empresa:</label>
          <select id="empresaSelect" class="form-select">
            <option value="">Sky Home S.A. de C.V.</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="fechaCorte" class="form-label">Fecha de Corte:</label>
          <input type="date" id="fechaCorte" class="form-control">
        </div>
        <div class="col-md-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="debugMode">
            <label class="form-check-label" for="debugMode">
              Modo Debug
            </label>
          </div>
        </div>
        <div class="col-md-3">
          <div class="d-flex gap-2">
            <button id="generateBtn" class="btn-generate">
              Generar Balance
            </button>
            <button id="printBtn" class="btn-print" onclick="window.print()">Imprimir</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Resumen de saldos -->
    <div id="summaryCards" class="summary-cards" style="display: none;">
      <div class="summary-card">
        <div class="summary-title">Total Activos</div>
        <div class="summary-amount" id="totalActivos">$0.00</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Total Pasivos</div>
        <div class="summary-amount" id="totalPasivos">$0.00</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Total Capital</div>
        <div class="summary-amount" id="totalCapital">$0.00</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Diferencia</div>
        <div class="summary-amount" id="diferencia">$0.00</div>
      </div>
    </div>

    <div id="balanceContent" class="balance-wrapper" style="display: none;">
      <table class="balance-table">
        <thead>
          <tr class="header-empresa">
            <td colspan="4" id="empresaNombre">Sky Home S.A. de C.V.</td>
          </tr>
          <tr class="header-titulo">
            <td colspan="4">Balance General al <span id="fechaBalance">fecha</span></td>
          </tr>
          <tr class="header-columns">
            <td width="25%">Activo</td>
            <td width="25%">Importe</td>
            <td width="25%">Pasivo y Capital</td>
            <td width="25%">Importe</td>
          </tr>
        </thead>
        <tbody id="balanceBody">
          <!-- Contenido dinámico -->
        </tbody>
      </table>
    </div>

    <!-- Mensaje cuando no hay datos -->
    <div id="noDataMessage" class="no-data-message">
      <p>No hay movimientos registrados para generar el balance.</p>
      <p>Primero registre algunos movimientos contables desde <a href="regisMov.html">Nuevo Movimiento</a></p>
    </div>
  </div>

  <script>
    // Variables globales
    const API_BASE = window.location.origin + '/api';
    let empresas = [{ id: 1, nombre: 'Sky Home S.A. de C.V.' }];
    let authToken = null;
    let debugMode = false;

    // Debug function
    function debugLog(message, data = null) {
      if (debugMode) {
        console.log(message, data);
        const debugContent = document.getElementById('debugContent');
        const debugInfo = document.getElementById('debugInfo');
        debugInfo.style.display = 'block';
        debugContent.innerHTML += `<div><strong>${new Date().toLocaleTimeString()}:</strong> ${message}</div>`;
        if (data) {
          debugContent.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
      }
    }

    // Verificar autenticación
    function checkAuth() {
      const loggedIn = localStorage.getItem('loggedIn');
      if (loggedIn === 'true') {
        debugLog('Autenticación: localStorage OK');
        return true;
      }
      
      authToken = localStorage.getItem('authToken');
      if (authToken) {
        debugLog('Autenticación: JWT Token encontrado');
        return true;
      }
      
      showMessage('Sesión expirada. Redirigiendo al login...', 'warning');
      setTimeout(() => {
        window.location.href = 'login.html';
      }, 2000);
      return false;
    }

    // Función para mostrar mensajes
    function showMessage(message, type = 'info') {
      const messageDiv = document.getElementById('statusMessage');
      messageDiv.className = `alert alert-${type}`;
      messageDiv.textContent = message;
      messageDiv.style.display = 'block';
      
      debugLog(`Mensaje mostrado: ${type}`, message);
      
      if (type !== 'danger') {
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 4000);
      }
    }

    // Función mejorada para hacer peticiones
    async function fetchWithAuth(url, options = {}) {
      debugLog('Haciendo petición a:', url);
      
      try {
        // Intentar primero con la API
        if (authToken) {
          const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`,
            ...options.headers
          };
          
          const response = await fetch(url, { ...options, headers });
          
          if (response.ok) {
            const data = await response.json();
            debugLog('API Response exitosa:', data);
            return data;
          } else {
            debugLog('API Response error:', response.status);
          }
        }

        // Fallback a datos locales
        debugLog('Usando fallback a datos locales');
        return handleLocalStorageMode(url, options);
        
      } catch (error) {
        debugLog('Error en petición, usando localStorage:', error);
        return handleLocalStorageMode(url, options);
      }
    }

    // Manejar modo localStorage mejorado
    function handleLocalStorageMode(url, options) {
      debugLog('Modo localStorage activado para:', url);
      
      if (url.includes('/balance-general')) {
        const movimientos = JSON.parse(localStorage.getItem('movimientos')) || [];
        debugLog('Movimientos desde localStorage:', movimientos);
        
        return Promise.resolve(generateBalanceFromLocalStorage(movimientos));
      }
      
      return Promise.resolve(null);
    }

    // Generar balance desde localStorage mejorado
    function generateBalanceFromLocalStorage(movimientos) {
      debugLog('Generando balance desde localStorage con movimientos:', movimientos.length);
      
      const fechaCorte = document.getElementById('fechaCorte').value;
      
      // Filtrar movimientos hasta la fecha de corte
      const movimientosFiltrados = movimientos.filter(mov => {
        const fechaMov = new Date(mov.fecha);
        const fechaCorteDate = new Date(fechaCorte + 'T23:59:59');
        return fechaMov <= fechaCorteDate;
      });
      
      debugLog('Movimientos filtrados por fecha:', movimientosFiltrados.length);
      
      if (movimientosFiltrados.length === 0) {
        return { 
          activo: { total: 0, circulante: [], fijo: [] }, 
          pasivo: { total: 0, corto_plazo: [], largo_plazo: [] }, 
          capital: { total: 0, cuentas: [] } 
        };
      }

      // Calcular saldos por cuenta
      const saldosCuentas = {};
      
      movimientosFiltrados.forEach(mov => {
        const nombreCuenta = mov.cuenta || 'Sin Cuenta';
        const cargo = parseFloat(mov.cargo) || 0;
        const abono = parseFloat(mov.abono) || 0;
        
        if (!saldosCuentas[nombreCuenta]) {
          saldosCuentas[nombreCuenta] = { debe: 0, haber: 0, saldo: 0 };
        }
        
        saldosCuentas[nombreCuenta].debe += cargo;
        saldosCuentas[nombreCuenta].haber += abono;
        saldosCuentas[nombreCuenta].saldo = saldosCuentas[nombreCuenta].debe - saldosCuentas[nombreCuenta].haber;
      });
      
      debugLog('Saldos por cuenta calculados:', saldosCuentas);

      const balance = {
        activo: { total: 0, circulante: [], fijo: [] },
        pasivo: { total: 0, corto_plazo: [], largo_plazo: [] },
        capital: { total: 0, cuentas: [] }
      };

      // Clasificar cuentas
      Object.entries(saldosCuentas).forEach(([nombreCuenta, datos]) => {
        const saldo = Math.abs(datos.saldo);
        
        if (saldo > 0.01) { // Solo cuentas con saldo significativo
          const codigo = extraerCodigo(nombreCuenta);
          const nombre = extraerNombre(nombreCuenta);
          const item = { codigo, nombre, saldo };
          
          // Clasificación mejorada
          if (esActivoCirculante(nombreCuenta, codigo)) {
            balance.activo.circulante.push(item);
            balance.activo.total += saldo;
          } else if (esActivoFijo(nombreCuenta, codigo)) {
            balance.activo.fijo.push(item);
            balance.activo.total += saldo;
          } else if (esPasivo(nombreCuenta, codigo)) {
            balance.pasivo.corto_plazo.push(item);
            balance.pasivo.total += saldo;
          } else if (esCapital(nombreCuenta, codigo)) {
            balance.capital.cuentas.push(item);
            balance.capital.total += saldo;
          } else if (esIngreso(nombreCuenta, codigo) && datos.saldo < 0) {
            // Los ingresos van al capital (saldo negativo normal)
            balance.capital.cuentas.push({ ...item, nombre: 'Utilidad - ' + nombre });
            balance.capital.total += saldo;
          } else if (esGasto(nombreCuenta, codigo) && datos.saldo > 0) {
            // Los gastos reducen el capital (saldo positivo normal)
            balance.capital.cuentas.push({ 
              ...item, 
              nombre: 'Pérdida - ' + nombre, 
              saldo: -saldo 
            });
            balance.capital.total -= saldo;
          }
        }
      });

      debugLog('Balance generado:', balance);
      return balance;
    }

    // Funciones auxiliares de clasificación
    function extraerCodigo(nombreCuenta) {
      const match = nombreCuenta.match(/^(\d+)/);
      return match ? match[1] : '';
    }

    function extraerNombre(nombreCuenta) {
      return nombreCuenta.replace(/^\d+\s*-\s*/, '').trim();
    }

    function esActivoCirculante(nombre, codigo) {
      const nombreLower = nombre.toLowerCase();
      return codigo.startsWith('1') || 
             nombreLower.includes('caja') || 
             nombreLower.includes('banco') || 
             nombreLower.includes('cliente') || 
             nombreLower.includes('inventario') ||
             nombreLower.includes('deudor');
    }

    function esActivoFijo(nombre, codigo) {
      const nombreLower = nombre.toLowerCase();
      return nombreLower.includes('equipo') || 
             nombreLower.includes('mobiliario') || 
             nombreLower.includes('maquinaria') ||
             nombreLower.includes('edificio') ||
             nombreLower.includes('terreno');
    }

    function esPasivo(nombre, codigo) {
      const nombreLower = nombre.toLowerCase();
      return codigo.startsWith('2') || 
             nombreLower.includes('proveedor') || 
             nombreLower.includes('acreedor') || 
             nombreLower.includes('prestamo') ||
             nombreLower.includes('por pagar');
    }

    function esCapital(nombre, codigo) {
      const nombreLower = nombre.toLowerCase();
      return codigo.startsWith('3') || 
             nombreLower.includes('capital') || 
             nombreLower.includes('patrimonio') ||
             nombreLower.includes('reserva');
    }

    function esIngreso(nombre, codigo) {
      const nombreLower = nombre.toLowerCase();
      return codigo.startsWith('4') || 
             nombreLower.includes('venta') || 
             nombreLower.includes('ingreso') ||
             nombreLower.includes('producto');
    }

    function esGasto(nombre, codigo) {
      const nombreLower = nombre.toLowerCase();
      return codigo.startsWith('5') || 
             nombreLower.includes('gasto') || 
             nombreLower.includes('compra') ||
             nombreLower.includes('costo');
    }

    // Obtener balance general
    async function getBalanceGeneral() {
      try {
        const fechaCorte = document.getElementById('fechaCorte').value;

        if (!fechaCorte) {
          throw new Error('Por favor seleccione una fecha de corte');
        }

        let url = `${API_BASE}/balance-general?fechaCorte=${fechaCorte}`;
        const balance = await fetchWithAuth(url);
        
        debugLog('Balance obtenido:', balance);
        return balance;
      } catch (error) {
        debugLog('Error obteniendo balance:', error);
        throw error;
      }
    }

    // Renderizar balance en la tabla
    function renderBalance(balance) {
      debugLog('Renderizando balance:', balance);
      
      // Actualizar fecha en el header
      const fechaCorte = document.getElementById('fechaCorte').value;
      const fecha = new Date(fechaCorte + 'T00:00:00');
      document.getElementById('fechaBalance').textContent = fecha.toLocaleDateString('es-MX', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });

      // Calcular totales
      const totalActivos = balance.activo.total || 0;
      const totalPasivos = balance.pasivo.total || 0;
      const totalCapital = balance.capital.total || 0;
      const totalPasivoCapital = totalPasivos + totalCapital;

      // Actualizar cards de resumen
      document.getElementById('totalActivos').textContent = '$' + totalActivos.toLocaleString('es-MX', {minimumFractionDigits: 2});
      document.getElementById('totalPasivos').textContent = '$' + totalPasivos.toLocaleString('es-MX', {minimumFractionDigits: 2});
      document.getElementById('totalCapital').textContent = '$' + totalCapital.toLocaleString('es-MX', {minimumFractionDigits: 2});
      document.getElementById('diferencia').textContent = '$' + (totalActivos - totalPasivoCapital).toLocaleString('es-MX', {minimumFractionDigits: 2});
      
      // Mostrar cards de resumen
      document.getElementById('summaryCards').style.display = 'grid';

      // Renderizar tabla
      const tbody = document.getElementById('balanceBody');
      tbody.innerHTML = '';

      // Preparar datos para la tabla
      const activosData = [
        ...balance.activo.circulante.map(item => ({...item, seccion: 'ACTIVO CIRCULANTE'})),
        ...balance.activo.fijo.map(item => ({...item, seccion: 'ACTIVO FIJO'}))
      ];

      const pasivosData = [
        ...balance.pasivo.corto_plazo.map(item => ({...item, seccion: 'PASIVO A CORTO PLAZO'})),
        ...balance.pasivo.largo_plazo.map(item => ({...item, seccion: 'PASIVO A LARGO PLAZO'}))
      ];

      const capitalData = balance.capital.cuentas.map(item => ({...item, seccion: 'CAPITAL'}));

      // Determinar número máximo de filas
      const maxRows = Math.max(
        activosData.length + 3, // +3 para secciones y total
        pasivosData.length + capitalData.length + 5 // +5 para secciones, totales y gran total
      );

      let activoIndex = 0;
      let pasivoIndex = 0;
      let capitalIndex = 0;
      let currentActivoSection = '';
      let currentPasivoSection = '';
      let currentCapitalSection = '';

      for (let i = 0; i < maxRows; i++) {
        const row = document.createElement('tr');
        
        // Columna Activo
        let activoCell = '';
        let activoAmount = '';
        
        if (activoIndex < activosData.length) {
          const activo = activosData[activoIndex];
          
          // Mostrar título de sección si cambió
          if (currentActivoSection !== activo.seccion) {
            activoCell = activo.seccion;
            activoAmount = '';
            currentActivoSection = activo.seccion;
            row.className = 'section-title';
          } else {
            activoCell = activo.nombre;
            activoAmount = '$' + activo.saldo.toLocaleString('es-MX', { minimumFractionDigits: 2 });
            activoIndex++;
          }
        } else if (i === activosData.length + 2) {
          activoCell = 'TOTAL ACTIVOS';
          activoAmount = '$' + totalActivos.toLocaleString('es-MX', { minimumFractionDigits: 2 });
          row.className = 'total-row';
        }

        // Columnas Pasivo y Capital
        let pasivoCapitalCell = '';
        let pasivoCapitalAmount = '';
        
        const totalPasivoItems = pasivosData.length;
        const totalCapitalItems = capitalData.length;
        
        if (pasivoIndex < totalPasivoItems) {
          const pasivo = pasivosData[pasivoIndex];
          
                      if (currentPasivoSection !== pasivo.seccion) {
            pasivoCapitalCell = pasivo.seccion;
            pasivoCapitalAmount = '';
            currentPasivoSection = pasivo.seccion;
            row.className = 'section-title';
          } else {
            pasivoCapitalCell = pasivo.nombre;
            pasivoCapitalAmount = '$' + pasivo.saldo.toLocaleString('es-MX', { minimumFractionDigits: 2 });
            pasivoIndex++;
          }
        } else if (pasivoIndex === totalPasivoItems && totalPasivos > 0) {
          pasivoCapitalCell = 'Total Pasivos';
          pasivoCapitalAmount = '$' + totalPasivos.toLocaleString('es-MX', { minimumFractionDigits: 2 });
          pasivoIndex++;
          row.className = 'total-row';
        } else if (capitalIndex < totalCapitalItems) {
          const capital = capitalData[capitalIndex];
          
          if (currentCapitalSection !== capital.seccion) {
            pasivoCapitalCell = capital.seccion;
            pasivoCapitalAmount = '';
            currentCapitalSection = capital.seccion;
            row.className = 'section-title';
          } else {
            pasivoCapitalCell = capital.nombre;
            pasivoCapitalAmount = '$' + capital.saldo.toLocaleString('es-MX', { minimumFractionDigits: 2 });
            capitalIndex++;
          }
        } else if (capitalIndex === totalCapitalItems && totalCapital !== 0) {
          pasivoCapitalCell = 'Total Capital';
          pasivoCapitalAmount = '$' + totalCapital.toLocaleString('es-MX', { minimumFractionDigits: 2 });
          capitalIndex++;
          row.className = 'total-row';
        } else if (i === maxRows - 1) {
          pasivoCapitalCell = 'TOTAL PASIVO + CAPITAL';
          pasivoCapitalAmount = '$' + totalPasivoCapital.toLocaleString('es-MX', { minimumFractionDigits: 2 });
          row.className = 'grand-total';
        }

        // Aplicar clases CSS
        const activoCellClass = (activoCell.includes('TOTAL') || activoCell.includes('ACTIVO')) ? '' : 'account-name';
        const pasivoCellClass = (pasivoCapitalCell.includes('TOTAL') || pasivoCapitalCell.includes('PASIVO') || pasivoCapitalCell.includes('CAPITAL')) ? '' : 'account-name';

        row.innerHTML = `<td class="${activoCellClass}">${activoCell}</td>` +
                       `<td class="amount">${activoAmount}</td>` +
                       `<td class="${pasivoCellClass}">${pasivoCapitalCell}</td>` +
                       `<td class="amount">${pasivoCapitalAmount}</td>`;

        tbody.appendChild(row);
      }

      // Mostrar el balance
      document.getElementById('balanceContent').style.display = 'block';
      document.getElementById('noDataMessage').style.display = 'none';
    }

    // Generar balance general
    async function generarBalance() {
      try {
        const btn = document.getElementById('generateBtn');
        const originalText = btn.textContent;
        
        // Mostrar loading
        btn.innerHTML = '<span class="loading-spinner"></span>Generando...';
        btn.disabled = true;

        debugLog('Iniciando generación de balance...');
        const balance = await getBalanceGeneral();
        
        if (!balance || (!balance.activo?.total && !balance.pasivo?.total && !balance.capital?.total)) {
          document.getElementById('noDataMessage').style.display = 'block';
          document.getElementById('balanceContent').style.display = 'none';
          document.getElementById('summaryCards').style.display = 'none';
          showMessage('No hay movimientos registrados para la fecha seleccionada', 'warning');
          return;
        }

        renderBalance(balance);
        showMessage('Balance generado correctamente', 'success');
        
      } catch (error) {
        console.error('Error generando balance:', error);
        showMessage('Error generando el balance: ' + error.message, 'danger');
        document.getElementById('noDataMessage').style.display = 'block';
        document.getElementById('balanceContent').style.display = 'none';
        document.getElementById('summaryCards').style.display = 'none';
      } finally {
        const btn = document.getElementById('generateBtn');
        btn.textContent = 'Generar Balance';
        btn.disabled = false;
      }
    }

    // Función para verificar datos en localStorage
    function verificarDatosLocalStorage() {
      const movimientos = JSON.parse(localStorage.getItem('movimientos')) || [];
      debugLog('Verificación de datos localStorage:', {
        totalMovimientos: movimientos.length,
        movimientos: movimientos.slice(0, 3) // Mostrar solo los primeros 3
      });
      
      if (movimientos.length > 0) {
        showMessage(`Se encontraron ${movimientos.length} movimientos en localStorage`, 'info');
      } else {
        showMessage('No se encontraron movimientos en localStorage', 'warning');
      }
    }

    // Función para testear la conexión API
    async function testearConexionAPI() {
      debugLog('Testeando conexión API...');
      
      try {
        const response = await fetch(`${API_BASE}/health`);
        const data = await response.json();
        debugLog('API Health Check:', data);
        showMessage('Conexión API: ' + data.status, data.status === 'OK' ? 'success' : 'warning');
      } catch (error) {
        debugLog('Error en API Health Check:', error);
        showMessage('API no disponible, usando datos locales', 'warning');
      }
    }

    // Inicialización
    document.addEventListener('DOMContentLoaded', async function() {
      if (!checkAuth()) return;

      // Establecer fecha actual por defecto
      const today = new Date();
      document.getElementById('fechaCorte').value = today.toISOString().split('T')[0];
      
      // Event listeners
      document.getElementById('generateBtn').addEventListener('click', generarBalance);
      
      document.getElementById('debugMode').addEventListener('change', function(e) {
        debugMode = e.target.checked;
        if (debugMode) {
          document.getElementById('debugInfo').style.display = 'block';
          debugLog('Modo debug activado');
          verificarDatosLocalStorage();
          testearConexionAPI();
        } else {
          document.getElementById('debugInfo').style.display = 'none';
          document.getElementById('debugContent').innerHTML = '';
        }
      });
      
      // Auto-generar balance al cargar
      setTimeout(() => {
        generarBalance();
      }, 1000);
    });
  </script>
</body>
</html>