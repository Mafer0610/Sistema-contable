<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Balance General - Sky Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #b19cd9 0%, #c2a5db 50%, #d4b3e0 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .main-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      margin: 30px auto;
      padding: 40px;
      max-width: 1200px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .page-title {
      color: #6b46a3;
      font-weight: bold;
      font-size: 1.8rem;
      text-align: center;
      margin-bottom: 5px;
    }
    .company-info {
      text-align: center;
      color: #8e7cc3;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    .date-info {
      text-align: center;
      color: #8e7cc3;
      margin-bottom: 30px;
      font-size: 1rem;
    }
    .btn-back {
      background: rgba(228, 165, 232, 0.8);
      color: #6b46a3;
      border: 2px solid #6b46a3;
      border-radius: 10px;
      padding: 10px 20px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      margin-bottom: 20px;
    }
    .btn-back:hover {
      background: #6b46a3;
      color: white;
      text-decoration: none;
    }
    .controls {
      background: rgba(228, 165, 232, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .btn-generate {
      background: linear-gradient(135deg, #6b46a3, #8e7cc3);
      border: none;
      border-radius: 10px;
      padding: 12px 30px;
      font-size: 1rem;
      font-weight: 600;
      color: white;
      transition: all 0.3s ease;
      margin: 0 10px;
    }
    .btn-generate:hover {
      background: linear-gradient(135deg, #5a3a8a, #7a6bb0);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(107, 70, 163, 0.4);
    }
    .btn-print {
      background: rgba(228, 165, 232, 0.8);
      color: #6b46a3;
      border: 2px solid #6b46a3;
      border-radius: 10px;
      padding: 10px 25px;
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 0 10px;
    }
    .btn-print:hover {
      background: #6b46a3;
      color: white;
    }
    .balance-wrapper {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      border: 2px solid #6b46a3;
      margin-bottom: 20px;
    }
    .balance-table {
      width: 100%;
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }
    .balance-table th,
    .balance-table td {
      padding: 8px 12px;
      border: 1px solid #6b46a3;
      text-align: left;
      vertical-align: top;
    }
    .header-empresa {
      background: #6b46a3;
      color: white;
      font-weight: bold;
      text-align: center;
      font-size: 1rem;
    }
    .header-titulo {
      background: #8e7cc3;
      color: white;
      font-weight: bold;
      text-align: center;
      font-size: 0.95rem;
    }
    .header-columns {
      background: #d4b3e0;
      color: #6b46a3;
      font-weight: bold;
      text-align: center;
      font-size: 0.85rem;
    }
    .section-title {
      background: #f0f0f0;
      font-weight: bold;
      text-align: center;
    }
    .account-name {
      padding-left: 20px;
    }
    .amount {
      text-align: right;
      font-weight: normal;
    }
    .total-row {
      font-weight: bold;
      background: #f8f9fa;
    }
    .grand-total {
      font-weight: bold;
      background: #e9ecef;
      border-top: 2px solid #6b46a3;
    }
    .form-control {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 8px 12px;
      transition: all 0.3s ease;
    }
    .form-control:focus {
      border-color: #6b46a3;
      box-shadow: 0 0 0 0.2rem rgba(107, 70, 163, 0.25);
    }
    .no-data-message {
      text-align: center;
      padding: 40px;
      color: #8e7cc3;
      font-size: 1.2rem;
    }
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .summary-card {
      background: rgba(228, 165, 232, 0.1);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      border: 2px solid #e4a5e8;
    }
    .summary-title {
      color: #6b46a3;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .summary-amount {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
    }
    @media print {
      body { background: white; }
      .main-container { background: white; box-shadow: none; border: none; }
      .btn-back, .controls, .summary-cards { display: none; }
      .balance-table { font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <a href="panel.html" class="btn-back">← Volver al Panel</a>
    
    <div class="controls">
      <div class="row align-items-end">
        <div class="col-md-6">
          <label for="fechaCorte" class="form-label">Fecha de Corte:</label>
          <input type="date" id="fechaCorte" class="form-control">
        </div>
        <div class="col-md-6">
          <div class="d-flex gap-2">
            <button id="generateBtn" class="btn-generate">Generar Balance</button>
            <button id="printBtn" class="btn-print" onclick="window.print()">Imprimir</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Resumen de saldos -->
    <div id="summaryCards" class="summary-cards" style="display: none;">
      <div class="summary-card">
        <div class="summary-title">Total Activos</div>
        <div class="summary-amount" id="totalActivos">$0.00</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Total Pasivos</div>
        <div class="summary-amount" id="totalPasivos">$0.00</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Total Capital</div>
        <div class="summary-amount" id="totalCapital">$0.00</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Diferencia</div>
        <div class="summary-amount" id="diferencia">$0.00</div>
      </div>
    </div>

    <div id="balanceContent" class="balance-wrapper" style="display: none;">
      <table class="balance-table">
        <thead>
          <tr class="header-empresa">
            <td colspan="4">Sky Home S.A. de C.V.</td>
          </tr>
          <tr class="header-titulo">
            <td colspan="4">Balance General al <span id="fechaBalance">fecha</span></td>
          </tr>
          <tr class="header-columns">
            <td width="25%">Activo</td>
            <td width="25%">Importe</td>
            <td width="25%">Pasivo y Capital</td>
            <td width="25%">Importe</td>
          </tr>
        </thead>
        <tbody id="balanceBody">
          <!-- Contenido dinámico -->
        </tbody>
      </table>
    </div>

    <!-- Mensaje cuando no hay datos -->
    <div id="noDataMessage" class="no-data-message">
      <p>No hay movimientos registrados para generar el balance.</p>
      <p>Primero registre algunos movimientos contables desde <a href="regisMov.html">Nuevo Movimiento</a></p>
    </div>
  </div>

  <script>
    // Variables globales
    let movimientos = [];

    // Verificar autenticación simple
    function checkAuth() {
      const loggedIn = localStorage.getItem('loggedIn');
      if (loggedIn !== 'true') {
        window.location.href = 'login.html';
        return false;
      }
      return true;
    }

    // Calcular saldos por cuenta
    function calcularSaldosPorCuenta(movimientos) {
      const saldos = {};
      
      movimientos.forEach(function(mov) {
        if (!saldos[mov.cuenta]) {
          saldos[mov.cuenta] = {
            cuenta: mov.cuenta,
            cargo: 0,
            abono: 0,
            saldo: 0
          };
        }
        
        saldos[mov.cuenta].cargo += mov.cargo || 0;
        saldos[mov.cuenta].abono += mov.abono || 0;
      });
      
      // Calcular saldo final para cada cuenta
      Object.keys(saldos).forEach(function(cuenta) {
        saldos[cuenta].saldo = saldos[cuenta].cargo - saldos[cuenta].abono;
      });
      
      return saldos;
    }

    // Organizar saldos en estructura de balance
    function organizarBalance(saldosCuentas) {
      const balance = {
        activos: [],
        pasivos: [],
        capital: []
      };

      Object.values(saldosCuentas).forEach(function(cuenta) {
        const nombre = cuenta.cuenta;
        const saldo = cuenta.saldo;
        
        if (saldo !== 0) {
          // Clasificar por tipo de cuenta basado en el código
          if (nombre.startsWith('1')) {
            // Activos (códigos 1xxx)
            if (saldo > 0) {
              balance.activos.push({
                nombre: nombre,
                saldo: Math.abs(saldo)
              });
            }
          } else if (nombre.startsWith('2')) {
            // Pasivos (códigos 2xxx)
            if (saldo < 0) {
              balance.pasivos.push({
                nombre: nombre,
                saldo: Math.abs(saldo)
              });
            } else if (saldo > 0) {
              balance.pasivos.push({
                nombre: nombre + ' (Ajuste)',
                saldo: saldo
              });
            }
          } else if (nombre.startsWith('3')) {
            // Capital (códigos 3xxx)
            balance.capital.push({
              nombre: nombre,
              saldo: Math.abs(saldo)
            });
          } else if (nombre.startsWith('4')) {
            // Ingresos (códigos 4xxx)
            if (saldo < 0) {
              balance.capital.push({
                nombre: 'Utilidad por ' + nombre,
                saldo: Math.abs(saldo)
              });
            }
          } else if (nombre.startsWith('5')) {
            // Gastos (códigos 5xxx)
            if (saldo > 0) {
              balance.capital.push({
                nombre: 'Pérdida por ' + nombre,
                saldo: -Math.abs(saldo)
              });
            }
          }
        }
      });

      return balance;
    }

    // Renderizar balance en la tabla
    function renderBalance(fechaCorte, balance) {
      // Actualizar fecha en el header
      const fecha = new Date(fechaCorte + 'T00:00:00');
      document.getElementById('fechaBalance').textContent = fecha.toLocaleDateString('es-MX', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });

      // Calcular totales
      const totalActivos = balance.activos.reduce(function(sum, item) {
        return sum + item.saldo;
      }, 0);
      
      const totalPasivos = balance.pasivos.reduce(function(sum, item) {
        return sum + item.saldo;
      }, 0);
      
      const totalCapital = balance.capital.reduce(function(sum, item) {
        return sum + item.saldo;
      }, 0);
      
      const totalPasivoCapital = totalPasivos + totalCapital;

      // Actualizar cards de resumen
      document.getElementById('totalActivos').textContent = '$' + totalActivos.toFixed(2);
      document.getElementById('totalPasivos').textContent = '$' + totalPasivos.toFixed(2);
      document.getElementById('totalCapital').textContent = '$' + totalCapital.toFixed(2);
      document.getElementById('diferencia').textContent = '$' + (totalActivos - totalPasivoCapital).toFixed(2);
      
      // Mostrar cards de resumen
      document.getElementById('summaryCards').style.display = 'grid';

      // Renderizar tabla
      const tbody = document.getElementById('balanceBody');
      tbody.innerHTML = '';

      // Determinar número máximo de filas
      const maxRows = Math.max(
        balance.activos.length + 2,
        balance.pasivos.length + balance.capital.length + 3
      );

      let activoIndex = 0;
      let pasivoIndex = 0;
      let capitalIndex = 0;

      for (let i = 0; i < maxRows; i++) {
        const row = document.createElement('tr');
        
        // Columna Activo
        let activoCell = '';
        let activoAmount = '';
        
        if (i === 0 && balance.activos.length > 0) {
          activoCell = 'ACTIVOS';
          activoAmount = '';
          row.className = 'section-title';
        } else if (i > 0 && activoIndex < balance.activos.length) {
          const activo = balance.activos[activoIndex];
          activoCell = activo.nombre;
          activoAmount = '$' + activo.saldo.toLocaleString('es-MX', { minimumFractionDigits: 2 });
          activoIndex++;
        } else if (i === balance.activos.length + 1 && balance.activos.length > 0) {
          activoCell = 'TOTAL ACTIVOS';
          activoAmount = '$' + totalActivos.toLocaleString('es-MX', { minimumFractionDigits: 2 });
          row.className = 'total-row';
        }

        // Columnas Pasivo y Capital
        let pasivoCapitalCell = '';
        let pasivoCapitalAmount = '';
        
        if (i === 0 && balance.pasivos.length > 0) {
          pasivoCapitalCell = 'PASIVOS';
          pasivoCapitalAmount = '';
          row.className = 'section-title';
        } else if (i > 0 && pasivoIndex < balance.pasivos.length) {
          const pasivo = balance.pasivos[pasivoIndex];
          pasivoCapitalCell = pasivo.nombre;
          pasivoCapitalAmount = '$' + pasivo.saldo.toLocaleString('es-MX', { minimumFractionDigits: 2 });
          pasivoIndex++;
        } else if (i === balance.pasivos.length + 1 && balance.pasivos.length > 0) {
          pasivoCapitalCell = 'Total Pasivos';
          pasivoCapitalAmount = '$' + totalPasivos.toLocaleString('es-MX', { minimumFractionDigits: 2 });
          row.className = 'total-row';
        } else if (i === balance.pasivos.length + 2 && balance.capital.length > 0) {
          pasivoCapitalCell = 'CAPITAL';
          pasivoCapitalAmount = '';
          row.className = 'section-title';
        } else if (capitalIndex < balance.capital.length) {
          const capital = balance.capital[capitalIndex];
          pasivoCapitalCell = capital.nombre;
          pasivoCapitalAmount = '$' + capital.saldo.toLocaleString('es-MX', { minimumFractionDigits: 2 });
          capitalIndex++;
        } else if (i === maxRows - 1) {
          pasivoCapitalCell = 'TOTAL PASIVO + CAPITAL';
          pasivoCapitalAmount = '$' + totalPasivoCapital.toLocaleString('es-MX', { minimumFractionDigits: 2 });
          row.className = 'grand-total';
        }

        // Aplicar clases CSS
        const activoCellClass = (activoCell.startsWith('TOTAL') || activoCell === 'ACTIVOS') ? '' : 'account-name';
        const pasivoCellClass = (pasivoCapitalCell.startsWith('TOTAL') || pasivoCapitalCell === 'PASIVOS' || pasivoCapitalCell === 'CAPITAL') ? '' : 'account-name';

        row.innerHTML = '<td class="' + activoCellClass + '">' + activoCell + '</td>' +
                       '<td class="amount">' + activoAmount + '</td>' +
                       '<td class="' + pasivoCellClass + '">' + pasivoCapitalCell + '</td>' +
                       '<td class="amount">' + pasivoCapitalAmount + '</td>';

        tbody.appendChild(row);
      }

      // Mostrar el balance
      document.getElementById('balanceContent').style.display = 'block';
    }

    // Generar balance general
    function generarBalance() {
      try {
        const fechaCorte = document.getElementById('fechaCorte').value;

        if (!fechaCorte) {
          alert('Por favor seleccione una fecha de corte');
          return;
        }

        // Mostrar loading
        document.getElementById('generateBtn').textContent = 'Generando...';
        document.getElementById('generateBtn').disabled = true;

        // Filtrar movimientos hasta la fecha de corte
        const movimientosFiltrados = movimientos.filter(function(mov) {
          return mov.fecha <= fechaCorte;
        });

        if (movimientosFiltrados.length === 0) {
          alert('No hay movimientos registrados hasta la fecha seleccionada');
          return;
        }

        // Calcular saldos por cuenta
        const saldosCuentas = calcularSaldosPorCuenta(movimientosFiltrados);
        
        // Organizar balance
        const balance = organizarBalance(saldosCuentas);
        
        // Renderizar balance
        renderBalance(fechaCorte, balance);
        
        // Ocultar mensaje de no datos
        document.getElementById('noDataMessage').style.display = 'none';

      } catch (error) {
        console.error('Error generando balance:', error);
        alert('Error generando el balance');
      } finally {
        document.getElementById('generateBtn').textContent = 'Generar Balance';
        document.getElementById('generateBtn').disabled = false;
      }
    }

    // Verificar auth al cargar
    if (!checkAuth()) {
      // Redirigir si no está autenticado
    } else {
      // Inicializar página
      document.addEventListener('DOMContentLoaded', function() {
        // Establecer fecha actual por defecto
        const today = new Date();
        document.getElementById('fechaCorte').value = today.toISOString().split('T')[0];
        
        // Event listener
        document.getElementById('generateBtn').addEventListener('click', generarBalance);
        
        // Cargar movimientos
        movimientos = JSON.parse(localStorage.getItem('movimientos')) || [];
        
        // Si no hay movimientos, mostrar mensaje
        if (movimientos.length === 0) {
          document.getElementById('noDataMessage').style.display = 'block';
        }
      });
    }
  </script>
</body>
</html>